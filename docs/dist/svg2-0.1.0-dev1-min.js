/*(c) 2023-2025 by D.G.MacCarthy [github.com/dmaccarthy/svg2]*/function jeval(t){return JSON.parse(`{"a": ${t}}`).a}function jeval_frac(t){return jeval((t=t.split("/"))[0])/(t.length>1?jeval(t[1]):1)}function click_cycle(t,e,...s){t.cycleStatus=e,$(t).click((e=>{let r=e.ctrlKey,i=s.length;t.cycleStatus+=r?-1:1,t.cycleStatus<0?t.cycleStatus=i-1:t.cycleStatus>=i&&(t.cycleStatus=0);let n=r?0:t.cycleStatus;for(;n<=t.cycleStatus;)s[n++]()}))}Array.prototype.item=function(t){return this[t<0?t+this.length:t]},click_cycle.toggle=(t,e,...s)=>{let r;try{r=t instanceof SVG2?t:null}catch(t){}for(let i of s){let s=r?r.$.find(`.Toggle${i}`):$(t[i]);e?s.fadeIn():null==e?s.fadeToggle():s.fadeOut()}};const range=function*(t,e,s){for(null==e&&(e=t,t=0),s||(s=t<e?1:-1);s>0&&t<e||s<0&&t>e;)yield t,t+=s};function qs_args(t,e){let s={};for(let[t,r]of new URLSearchParams(e||location.search))s[t]=r;return t?s[t]:s}function item_aspect(t,e){let s=jeval_frac((t=$(t)).attr("data-aspect"));if(e){t.css({width:""});let e=Math.round(t.height()*s);e!=t.width()&&t.width(e)}else{t.css({height:""});let e=Math.round(t.width()/s);e!=t.height()&&t.height(e)}}function aspect(t){let e=$("[data-aspect]");for(let s=0;s<e.length;s++)item_aspect(e[s],t)}const random_string=(t,e)=>{let s="";for(2==e&&(s=random_string(1),t--);t--;){let t=Math.floor((e?62:52)*Math.random());t=(t<26?65:t<52?97:48)+t%26,s+=String.fromCharCode(t)}return s};function*_zip(t,e,s){let r=t instanceof Array,i=e instanceof Array,n=r?t.length:e.length;for(let a=0;a<n;a++){let n=r?t[a]:t,l=i?e[a]:e;yield s?new RArray(n,l):[n,l]}}function zip(t,e,s){return[..._zip(t,e,s)]}function unzip(t,e){let s=t[0].length,r=new Array(s);for(let t=0;t<r.length;t++)r[t]=e?new RArray:[];for(let e=0;e<t.length;e++)for(let i=0;i<s;i++)r[i].push(t[e][i]);return r}function unicode_to_base64(t){let e=(new TextEncoder).encode(t);return btoa(String.fromCharCode(...e))}function katex_render(t,e){t=$(t||".TeX").removeClass("TeX");for(let s of t){let t=$(s),r=t.text();t.attr("data-latex",r);let i={displayMode:t.is("p, div, .Display"),throwOnError:!1};e&&Object.assign(i,e),katex.render(r,s,i)}katex_render.hideEqNum&&$("[data-latex]:is(p, div) .eqn-num").hide()}async function mjax_render(t,e){t=$(t||".TeX").addClass("TeX_Pending").removeClass("TeX");let s=[];for(let r of t){let t=$(r),i=t.text();t.attr("data-latex",i),f=e?t=>$(t):t=>$(t).find("svg"),s.push(MathJax.tex2svgPromise(i).then((e=>t.removeClass("TeX_Pending").html(f(e)[0]))))}return new Promise((async t=>{for(let t=0;t<s.length;t++)await s[t];t()}))}async function mjax_wait(t){for(;!MathJax.typesetPromise;)await SVG2.sleep(t||50);return new Promise((t=>t()))}async function mjax_svg(t){return MathJax.tex2svgPromise(t).then((t=>$($(t).find("svg")[0])))}async function mjax_url(t){return mjax_svg(t).then((t=>"data:image/svg+xml;base64,"+unicode_to_base64(t[0].outerHTML)))}function mjax_img(t){return mjax_url(t).then((t=>$("<img>").attr({src:t})))}async function load_img(t){return new Promise((e=>{let s=new Image;s.addEventListener("load",(()=>e(s))),s.src=t}))}async function blobify(t,...e){return new Promise((s=>{if(t instanceof Blob)t.save=blobify._save,s(t);else if(t.toBlob)t.toBlob((t=>{t.save=blobify._save,s(t)}),...e);else{let r=new Blob([t],{type:e.length?e[0]:"text/plain"});r.save=blobify._save,s(r)}}))}function img2canvas(t,e){if(e||(e=1),!(e instanceof Array)){let s=$(t);e=[Math.round(e*s.width()),Math.round(e*s.height())]}let[s,r]=e;if(s*r==0)throw"Image has a dimension of 0";let i=$("<canvas>").attr({width:s,height:r})[0];return i.getContext("2d").drawImage(t,0,0,s,r),i}async function load_one_blob(t,e){return new Promise(((s,r)=>{fetch(t).then((t=>t.blob().then((i=>{if(t.ok)if(e){const t=new FileReader;t.onloadend=t=>s(t.target.result),t.readAsDataURL(i)}else s(i);else r(i)}))))}))}async function _load_blobs(t,...e){let s={},r={};for(let i of e)r[i]=load_one_blob(i,t).then((t=>s[i]=t),(()=>s[i]=null));for(let t of e)await r[t];return new Promise((t=>{t(s)}))}async function load_blobs(...t){return _load_blobs(0,...t)}async function load_dataURLs(...t){return _load_blobs(1,...t)}function code_echo(t,e){let s=t.text();if(e){let r=t.attr("data-echo"),i=r.split(".").pop();r==i&&(r=random_string(12,1)+"."+i),"html"!=i&&"htm"!=i||(-1==s.search("</body>")&&(s=`<body>\n${s}\n</body>`),-1==s.search("</head>")&&(s=`${code_echo.head}\n${s}\n`),-1==s.search("</html>")&&(s=`${code_echo.html}\n${s}\n</html>`)),blobify(s,blobify.mime(i)).then((t=>t.save(2==e?r:null)))}else navigator.clipboard.writeText(s).then((()=>msg("Text copied to clipboard")),(()=>msg("Unable to copy text")))}katex_render.hideEqNum=!0,renderTeX=mjax_render,blobify._save=function(t){let e=URL.createObjectURL(this);t?$("<a>").attr({href:e,download:t})[0].click():window.open(e),URL.revokeObjectURL(e)},blobify.mime=t=>{let e={html:"text/html",htm:"text/html",js:"text/javascript",css:"text/css",csv:"text/csv",py:"text/python",svg:"image/svg+xml",png:"image/png",jpg:"image/jpeg",webp:"image/webp",json:"application/json",xml:"application/xml",pdf:"application/pdf",zip:"application/zip"}[t.split(".").pop().toLowerCase()];return e||"text/plain"},code_echo.html='<!DOCTYPE html>\n<html lang="en-ca">',code_echo.head='<head>\n<meta charset="utf8"/>\n<meta name="viewport" content="width=device-width, initial-scale=1"/>\n<title>HTML Document</title>\n<link rel="shortcut icon" type="image/svg+xml" href="https://upload.wikimedia.org/wikipedia/commons/6/61/HTML5_logo_and_wordmark.svg"/>\n</head>';const pi=Math.PI,DEG=pi/180,RAD=180/pi,twoPi=2*pi,halfPi=pi/2,quarterPi=pi/4;class RArray extends Array{static add(...t){let e=new RArray,s=t[0].length;for(let r=0;r<s;r++){let s=0;for(let e=0;e<t.length;e++)s+=t[e][r];e.push(s)}return e}static convert(...t){let e=[];for(let s of t)e.push(new RArray(...s));return e}sum(){let t=this.length,e=0;if(t){e=this[0];for(let s=1;s<t;s++)e+=this[s]}return e}minmax(){let t=this[0],e=t;for(let s=0;s<this.length;s++)this[s]<t&&(t=this[s]),this[s]>e&&(e=this[s]);return{min:t,max:e}}extend(t){return this.push.apply(this,t),this}remove(t,e){let s=!0;for(;s;){let r=this.indexOf(t);r>=0&&this.splice(r,1),-1!=r&&e||(s=!1)}return this}times(t){let e=t instanceof Array,s=new RArray;for(let r=0;r<this.length;r++)s.push(this[r]*(e?t[r]:t));return s}neg(){return this.times(-1)}plus(t){return RArray.add(this,t)}minus(t){let e=new RArray;for(let s=0;s<this.length;s++)e.push(this[s]-t[s]);return e}dot(t){let e=0;for(let s=0;s<this.length;s++)e+=this[s]*t[s];return e}mag(){return Math.sqrt(this.dot(this))}dir(){if(2!=this.length)throw"ValueError: operation applies only to arrays of length 2";return atan2(this[1],this[0])}tr(t,e){t||(t=4);let s=$("<tr>"),r=[this.mag(),this.dir(),this[0],this[1]];for(let i of r)e&&(i*=e),s.append($("<td>").html(i.toPrecision(t)));return s}}function xy_limits(...t){let e=new RArray(0,0),s=[e];for(let r of t)e=e.plus(r),s.push(e);let[r,i]=unzip(s,!0);return r=r.minmax(),i=i.minmax(),{x:r,y:i,center:[(r.min+r.max)/2,(i.min+i.max)/2],size:[r.max-r.min,i.max-i.min]}}function*fn_eval(t,e){for(let s of e)yield t(s)}function uniform(t,e){return t+(e-t)*Math.random()}function randint(t,e){return null==e&&(e=t,t=0),t+Math.floor((e+1-t)*Math.random())}function shuffle(t){for(let e=t.length-1;e>0;e--){let s=randint(e+1);[t[e],t[s]]=[t[s],t[e]]}}function arrow_points(t,e){e||(e={});let s=(e.angle?e.angle:35)*DEG,r=e.tail?e.tail:t/14;r<0&&(r*=-t);let i=e.head?e.head:4*r,n=Math.cos(s),a=Math.sin(s),l=r/2,o=-i*n,h=o-r*a,c=i*a,u=c-r*n,p=h-(l-u)*n/a;(p<h||2==e.shape)&&(p=h),u<l&&(u=l);let d=RArray.convert([0,0],[o,c],[h,u],[p,l],[-t,l],[-t,-l],[p,-l],[h,-u],[o,-c]);(e.shape||c<l)&&(d.splice(8,1),d.splice(1,1)),t/=2;for(let e=0;e<d.length;e++)d[e][0]+=t;if(e.double){let t=Math.floor(d.length/2),e=d.slice(0,t),s=t=>{let[e,s]=d[t];return new RArray(-e,s)};for(let r=0;r<t;r++)e.push(s(t-1-r));t=e.length-2,s=t=>{let[s,r]=e[t];return new RArray(s,-r)};for(let r=t;r>0;r--)e.push(s(r));d=e}return d}function star_points(t,e,s){return s||(s=3*e/7),[...fn_eval((r=>vec2d(r%2?s:e,90*(1+2*r/t))),range(0,2*t))]}function sq(t){return t*t}function root(t,e){return Math.pow(t,1/(null==e?2:e))}function sin(t){return Math.sin(t*DEG)}function cos(t){return Math.cos(t*DEG)}function tan(t){return Math.tan(t*DEG)}function asin(t){return Math.asin(t)*RAD}function acos(t){return Math.acos(t)*RAD}function atan(t){return Math.atan(t)*RAD}function atan2(t,e){return Math.atan2(t,e)*RAD}function hypot(t,e){return Math.sqrt(t*t+e*e)}const log=(t,e)=>(t=Math.log(t),e?t/Math.log(e):t),vec2d=(t,e,s)=>(s||(e*=DEG),new RArray(t*Math.cos(e),t*Math.sin(e))),vec=(...t)=>new RArray(...t),adjust_angle=(t,e,s)=>{for(null==e&&(e=0),null==s&&(s=e+360);t<e;)t+=360;for(;t>=s;)t-=360;return t};class Segment{constructor(t,e,s,r){null==s&&(s=t,r=e,t=e=0);let i=s-t,n=r-e,a=Math.sqrt(i*i+n*n),l=new RArray(i/a,n/a),o=Math.atan2(n,i),h=this;Object.assign(this,{point1:new RArray(t,e),point2:new RArray(s,r),length:a,rad:o,deg:o*RAD,slope:l[1]/l[0],midpoint:new RArray(t+i/2,e+n/2),unitVector:l,vector:new RArray(i,n),normal:new RArray(-l[1],l[0]),point:s=>new RArray(t+l[0]*s,e+l[1]*s),params:(s,r)=>{let i=(s-t)*l[0]+(r-e)*l[1],n=(t-s)*l[1]+(r-e)*l[0];return new RArray(i,n)},closest:(s,r)=>h.point((s-t)*l[0]+(r-e)*l[1])})}static point_slope(t,e,s,r){let[i,n]=Math.abs(s)==1/0?new RArray(0,s<0?-e:e):new RArray(1,s).times(e/hypot(1,s)),[a,l]=r?new RArray(-i/2,-n/2).plus(t):t;return new Segment(a,l,a+i,l+n)}}function _SSS(t,e,s){return acos((s*s-t*t-e*e)/(-2*t*e))}function SSS(t,e,s){return[_SSS(e,s,t),_SSS(t,s,e),_SSS(t,e,s)]}function SAS(t,e,s){let r=root(t*t+s*s-2*t*s*cos(e)),i=_SSS(s,r,t);return[i,r,180-(i+e)]}function ASA(t,e,s){let r=180-(t+s);return[(e/=sin(r))*sin(t),r,e*sin(s)]}function SSA(t,e,s,r){let i=asin(e*sin(s)/t);r&&(i=180-i);let n=180-(s+i);if(n>=0)return[root(t*t+e*e-2*t*e*cos(n)),n,i]}function quad_form(t,e,s){return[(-e+root(e*e-4*t*s))/(2*t),(-e-root(e*e-4*t*s))/(2*t)]}const transform=(t,...e)=>{let s=t.angle?t.angle:0;t.deg&&(s*=DEG);let r=Math.cos(s),i=Math.sin(s),n=0,a=0;t.center&&(n=t.center[0],a=t.center[1]);let l=n,o=a;t.shift&&(l+=t.shift[0],o+=t.shift[1]);let h=[];for(let t=0;t<e.length;t++){let s=e[t][0]-n,c=e[t][1]-a;h.push(new RArray(s*r-c*i+l,s*i+c*r+o))}return h};function lin_reg_xy(t,e){let s=t.length;if(e.length!=s)throw"Dimension error";t=new RArray(...t),e=new RArray(...e);let r=t.sum(),i=e.sum(),n=(s*t.dot(e)-r*i)/(s*t.dot(t)-r*r),a=(i-n*r)/s;return{m:n,b:a,fn:t=>n*t+a}}function exp_reg_xy(t,e){let s=e.length,r=new Array(s);for(let t=0;t<s;t++)r[t]=Math.log(e[t]);let i=lin_reg_xy(t,r),n=Math.exp(i.b),a=i.m;return{a:n,k:a,fn:t=>n*Math.exp(a*t)}}function pwr_reg_xy(t,e){let s=t.length,r=new Array(t),i=new Array(s);for(let n=0;n<s;n++)r[n]=Math.log(t[n]),i[n]=Math.log(e[n]);let n=lin_reg_xy(r,i),a=Math.exp(n.b);return s=n.m,{a:a,n:s,fn:t=>a*Math.pow(t,s)}}function lin_reg(...t){return lin_reg_xy(...unzip(t))}function exp_reg(...t){return exp_reg_xy(...unzip(t))}function pwr_reg(...t){return pwr_reg_xy(...unzip(t))}function gcf(t,e){let s=parseInt(t),r=parseInt(e);if(t!=s||e!=r||isNaN(s)||isNaN(r)||t<1||e<1)throw"Invald argument";if([t,e]=[Math.min(s,r),Math.max(s,r)],e%t==0)return t;let i=1,n=2;for(;2*n<=t;)t%n==0&&e%n==0&&(i=n),n++;return i}function lcm(t,e){return Math.round(t/gcf(t,e)*e)}class SVG2group{constructor(t,e){t&&(this.element=e?$(e)[0]:document.createElementNS(SVG2.nsURI,"g"),this.element._gr=this,this.$=$(this.element),this.$.appendTo(e?e.$:t.$),this.svg=t.svg,this._pivot=new RArray(0,0),this._shift=new RArray(0,0),this._vel=new RArray(0,0),this._acc=new RArray(0,0),this.thetaMode=1,this._theta=0,this.omega=0,this.alpha=0)}group(...t){let e=new SVG2group(this.svg,this.create_child("g"));return t&&e.css(...t),e}scaled(t){return new SVG2scaled(this.svg,this.create_child("g"),t)}get parent(){let t=this.$.parent().closest("g, svg");return t.length?t[0]._gr:null}gpath(){let t=this.parent,e=[this];return t?t.gpath().concat(e):e}get key(){return this._key}set key(t){let e=this.svg;if(t){if(e._key_map[t])throw`Key '${t}' already exists`;e._key_map[t]=this}else delete this._key}find(t,e){if(t instanceof $&&(t=t[0]),t instanceof SVGElement)return t._gr;let s=this.svg._key_map[t];return s||(s=this.$.find(t)[e||0],s=s?s._gr:null),s}find_all(t){let e=[];for(let s of this.$.find(t))s._gr instanceof SVG2group&&e.push(s._gr);return e}create_child(t,e,s){let r=$(document.createElementNS(SVG2.nsURI,t));return r.attr(e||{}),s&&r.html(s),r.appendTo(this.element)}config(t){for(let e in t)this[e]=t[e];return this.update_transform()}addClass(...t){return this.$.addClass(...t),this}css(...t){return SVG2.style(this.$,...t),this}update_transform(){let t=this.svg,e=this.theta*t.angleDir,[s,r]=t.scale.times(this.shift),i=e=>e.toFixed(t.decimals),n=s||r?`translate(${i(s)} ${i(r)})`:"";if(e){let[s,r]=t.a2p(...this.pivot);n+=` rotate(${i(e)} ${i(s)} ${i(r)})`}return n=n.trim(),n.length?this.$.attr("transform",n):this.$.removeAttr("transform"),this}cs_radius(t){return"string"==typeof t?parseFloat(t)/this.svg.unit:t}px_radius(t){return"string"==typeof t?parseFloat(t):t*this.svg.unit}px_size(t){null==t&&(t=[0,0]);let[e,s]=t,[r,i]=this.svg.scale;return e="string"==typeof e?parseFloat(e):Math.abs(e*r),s="string"==typeof s?parseFloat(s):Math.abs(s*i),new RArray(e,s)}cs_size(t){null==t&&(t=[0,0]);let[e,s]=t,[r,i]=this.svg.scale;return"string"==typeof e&&(e=parseFloat(e)/Math.abs(r)),"string"==typeof s&&(s=parseFloat(s)/Math.abs(i)),new RArray(e,s)}coord_from_parent(t){let e=this.theta*this.svg.angleDir;return t=this._shift.neg().plus(t),transform({angle:e,deg:!0,center:this._pivot},t)[0]}coord_to_parent(t){let e=this.theta*this.svg.angleDir;return transform({angle:-e,deg:!0,center:this._pivot,shift:this._shift},t)[0]}coord_to_svg(t){let e=this;for(;e.parent;)t=e.coord_to_parent(t),e=e.parent;return t}coord_from_svg(t){let e=this.gpath();for(let s=1;s<e.length;s++)t=e[s].coord_from_parent(t);return t}get bbox_px(){return this.element.getBBox()}get bbox_cs(){let t=this.svg,e=this.element.getBBox(),s=new RArray(e.x,e.y),r=s.plus([e.width,e.height]);return s=t.p2a(...s),r=t.p2a(...r),{x:s[0],y:s[1],width:Math.abs(r[0]-s[0]),height:Math.abs(r[1]-s[1])}}draw_bbox(t,e){let s=(t?this.svg:this).group();e||(css(s.circle("3",this.pivot)),e=1);let r=this.bbox_cs;return 1&e&&css(s.rect([r.width,r.height],[r.x,r.y,"tl"]),{"fill-opacity":.2}),2&e&&css(s.circle("3",this.pivot)),s.css({"fill-opacity":.7})}static _anchor(t){if(null==t&&(t=[0,0]),4==t.length)return t;if(3==t.length)return[t[0],t[1],...SVG2.parse_anchor(t[2])];if(t[0]instanceof Array){let e="string"==typeof t[1]?SVG2.parse_anchor(t[1]):t[1];return[...t[0],...e]}return[...t,.5,.5]}rect_xy(t,e){let[s,r,i,n]=SVG2._anchor(e),a=this.svg,[l,o]=this.px_size(t);return[s,r]=a.a2p(...this.cs_size([s,r])),[l,o,s-i*l,r-n*o]}align(t,e){if(null==t){if(null==(t=this._aligned_posn))return this;[t,e]=t}let[s,r,i,n]=SVG2._anchor(t),[a,l]=this.svg.scale,o=this.bbox_cs;return e&&(e=e.trim().toLowerCase()),"y"!=e&&(s-=i*o.width*(a<0?-1:1)),"x"!=e&&(r-=n*o.height*(l<0?-1:1)),this.config({_aligned_posn:[t,e],shift:[s-o.x,r-o.y]})}realign_text(t,e){if(clearTimeout(this.realign_text_timeout),null==e&&(e=10),!1!==t)for(let t of this.find_all("g"))t._aligned_posn&&t.$.find("text").length&&console.log(t.align());t&&e>1&&(this.realign_text_timeout=setTimeout((()=>this.realign_text(t,e-1)),t))}get pivot(){return this._pivot}get shift(){return this._shift}get vel(){return this._vel}get acc(){return this._acc}get theta(){return this._theta}set pivot(t){this._pivot=new RArray(...this.cs_size(t))}set shift(t){this._shift=new RArray(...this.cs_size(t))}set vel(t){this._vel=new RArray(...this.cs_size(t))}set acc(t){this._acc=new RArray(...this.cs_size(t))}set theta(t){if(this.thetaMode){for(;t>=360;)t-=360;for(;t<0;)t+=360}this._theta=t}shift_by(t){return this._shift=this._shift.plus(this.cs_size(t)),this.update_transform()}update(t){let e=this.alpha,s=this.omega;e&&(this.omega+=t*e,s+=t/2*e),s&&(this.theta=this.theta+t*s);let r=this._vel,i=this._acc;if(r||i){let e=i.times(t/2);r=r.plus(e),this._vel=r.plus(e),this._shift=this._shift.plus(r.times(t))}return this.update_transform()}get animated(){return this.svg.items.indexOf(this)>-1}set animated(t){SVG2.set_animated(this,t)}clip_path(t,e){let s=this.$,r=$(document.createElementNS(SVG2.nsURI,"clipPath")).attr({id:t});r.appendTo(this.svg.defs[0]),e?r.html(s.html()):s.children().appendTo(r);let i=s.attr("transform");return i&&r.children().attr({transform:i}),r}clip(t){return this.$.attr({"clip-path":`url(#${t})`}),this}line(t,e,s){let r=s?$($(s)[0]):this.create_child("line"),i=this.svg,n=t=>t.toFixed(i.decimals),[a,l]=i.a2p(...this.cs_size(t)),[o,h]=i.a2p(...this.cs_size(e));return r.attr({x1:n(a),y1:n(l),x2:n(o),y2:n(h)})}circle(t,e,s){let r=s?$($(s)[0]):this.create_child("circle"),i=this.svg,n=t=>t.toFixed(i.decimals),a=`${n(2*(t=i.px_radius(t)))}`,[l,o,h,c]=this.rect_xy([a,a],e);return r.attr({r:n(t),cx:n(h+l/2),cy:n(c+o/2)})}ellipse(t,e,s){let r=s?$($(s)[0]):this.create_child("ellipse"),i=this.svg,n=t=>t.toFixed(i.decimals),[a,l]=i.px_size(t),[o,h,c,u]=this.rect_xy([n(2*a),n(2*l)],e);return r.attr({rx:n(a),ry:n(l),cx:n(c+o/2),cy:n(u+h/2)})}rect(t,e,s){let r=s?$($(s)[0]):this.create_child("rect"),i=t=>t.toFixed(this.svg.decimals),[n,a,l,o]=this.rect_xy(t,e);return r.attr({width:i(n),height:i(a),x:i(l),y:i(o)})}poly(t,e){let s={points:this.svg.pts_str(t)};return $(e)[0]instanceof SVGElement?$(e).attr(s):this.create_child(e?"polygon":"polyline",s)}_img_size(t,e){t||(t={scale:1});let s=t.scale;if(s){let[r,i]=[e.width,e.height];r&&i||console.warn("Sizing image with a dimension of 0"),t=[(s*r).toFixed(2),(s*i).toFixed(2)]}else t instanceof Array||(t=[t,t]);return t}async image(t,e,s,r){t=new URL(t,location.href).href;let i=r?$($(r)[0]):this.create_child("image");return load_img(t).then((r=>{e=this._img_size(e,{width:r.naturalWidth,height:r.naturalHeight});let[n,a,l,o]=this.rect_xy(e,s),h=t=>t.toFixed(this.svg.decimals);return i.attr({href:t,width:h(n),height:h(a),x:h(l),y:h(o)})}))}static mjax_natural_size(t){let e=t.attr("width"),s=t.attr("height");if(-1==e.indexOf("ex")||-1==s.indexOf("ex"))throw"Expecting 'ex' units in MathJax SVG";return{width:14*parseFloat(e),height:14*parseFloat(s)}}async mjax(t,e,s,r,i){let n=this.group(),a=n.create_child("image");return null==e&&(e={scale:1}),t=t.replace("↡","\\scriptsize"),r&&(t=`\\color{${r}}{${t}}`),mjax_svg(t).then((t=>{e=this._img_size(e,SVG2.mjax_natural_size(t));let[r,l,o,h]=this.rect_xy(e,s),c=t=>t.toFixed(this.svg.decimals),u="data:image/svg+xml;base64,"+unicode_to_base64(t[0].outerHTML);if(a.attr({href:u,width:c(r),height:c(l),x:c(o),y:c(h)}),i){let t=s[2]instanceof Array?s[1]:[s[0],s[1]];n.config({theta:i,pivot:t})}return n}))}arrow(t,e,s){return new SVG2arrow(this,t,e,s)}locus(t,e,s){return new SVG2locus(this,t,e,s)}path(t){return new SVG2path(this,t)}star(t,e,s){let r=star_points(t,this.cs_radius(e),null==s?null:this.cs_radius(s));return this.poly(r,1)}chevron(t,e,s){null==s&&(s="7");let r=s.ratio;r?s=s.size:r=1;let i=this.svg.scale,n=-(s=this.px_radius(s))/i[0],a=r*s/i[1],l=this.group();return l.poly([[n,a],[0,0],[n,-a]]),l.config({shift:t,theta:e||0})}ray(t,e,s,...r){let i=this.group(".Ray");i.line(t,e);let n=i.seg=new Segment(...t,...e),a=this.svg,l=n.length;0==r.length&&(r=[.5]);for(let t of r)i.chevron(n.point(t*l),a.adjust_angle(n.deg),s);return i}ruler(t,e,s){"string"==typeof e&&(e=parseFloat(e)/Math.abs(this.svg.scale[1])),s=Object.assign({big:10,offset:0,tickSmall:.25,tickBig:.5},s);let r=this.group(".Ruler"),i=r.rulerLength=e*(t+2*s.offset),n=s.width?s.width:r.rulerLength/25;r.rect([i,n]);let a=e*s.offset-i/2;n/=2;for(let i=0;i<=t;i++)r.line([a,-n],[a,n*(2*(i%s.big?s.tickSmall:s.tickBig)-1)]),a+=e;return r}cylinder(t,e){t=this.cs_size(t),"string"==typeof e&&(e=Math.abs(parseFloat(e)/this.svg.scale[1]));let s=this.group(".Cylinder"),r=new RArray(t[0],0),i=r.neg().minus([0,e]),n=-1==s.svg.angleDir?2:0;return s.path(r).ver(-e).arc_to(i,t,n).ver(0).arc_to(r,t).close().update(),s.ellipse(t),s}plusminus(t,e,s){let r=this.svg,i=this.group();s||(s=.17),t=r.cs_radius(t);let[n,a]=r.cs_size([t,t]).times(.5),[l,o]=[n*s,a*s],h=e?[[l,a],[l,o],[n,o],[n,-o],[l,-o],[l,-a],[-l,-a],[-l,-o],[-n,-o],[-n,o],[-l,o],[-l,a]]:[[n,o],[n,-o],[-n,-o],[-n,o]];return i.poly(h,1),i}stickman(t){let e=this.group(".Stickman","none","black@3");"string"==typeof t&&(t=Math.abs(parseFloat(t)/this.svg.scale[1]));let s=t/8;e.circle(s,[0,7*s]),e.line([0,6*s],[0,3*s]);let r=1.2*s;e.poly([[-r,0],[0,3*s],[r,0]]);let i=new RArray(0,5*s);return s*=1.5,e.poly([i.plus(vec2d(s,uniform(150,210))),i,i.plus(vec2d(s,uniform(-30,30)))]),e}coil(t,e,s,r,i){let n=this.group();n.$.addClass("Coil");let a=s?n.scaled([-1,1]):n,[l,o]=t;e||(e=15),r||(r=o/e/4),a.rect(t);for(let s=0;s<e+.5;s++){let i=(o-6*r)*(s-e/2)/e;a._turn(t[0],r,s==e?2:3).config({shift:[0,i]}).$.addClass("Wire"),0!=s&&s!=e||(i+=r*(s?2:-2),a.line([l/2,i],[l/2+2*r,i]).addClass("Wire"))}return null==i&&(i=.7*r),i&&a.circle(i),n}_turn(t,e,s){let r=this.group();null==s&&(s=0),t/=2;let i=r.path([t,1&s?4*e:2*e]);return 1&s&&i.arc([t,3*e],-90),i.line_to([-t,-2*e]),2&s&&i.arc([-t,-e],90,2),i.update(),r}text(t,e,s,r){return new SVG2text(this,t,e,s,r)}gtext(t,e,s,r){return new SVG2text(this,t,s,r,e)}grid(t,e,s){let r=this.group("grid");this._grid(r,t,e),this._grid(r,e,t,1);let i=r.$.addClass("Grid");return(null==s||s)&&i.find(".Axis").appendTo(i),r}_grid(t,e,s,r){if(3==e.length){let[i,n,a]=e,[l,o]=s;[i,n]=[Math.min(i,n),Math.max(i,n)],[l,o]=[Math.min(l,o),Math.max(l,o)],a<0&&(a=-a);let h=a/1e3;for(n+=h;i<=n;){let e=r?[[l,i],[o,i]]:[[i,l],[i,o]],s=t.line(...e);Math.abs(i)<h&&s.addClass("Axis").css({stroke:"black","stroke-width":"1px"}),i+=a}}}ticks(t,e){if(e){let e={size:["-6",0],css:15,label:0,shift:"-8"};t=t?Object.assign(e,t):e}let s,r,i,n,a=this.svg,[l,o,h,c,u]=[t.x,t.y,t.size,t.label,t.skip],p=o instanceof Array,d=this.group(p?".TicksY":".TicksX");p&&([l,o]=[o,l]),o||(o=0);let[f,g,m]=l;if(h&&(i=d.group(".Ticks","black@1"),s=a.cs_size(p?[h[0],0]:[0,h[0]]),r=a.cs_size(p?[h[1],0]:[0,h[1]])),null!=c){let e=t.anchor?t.anchor:p?"r":"t";n=d.group(".Labels",SVG2.parse_anchor(e,1));let[s,r]=[t.css,t.shift];s&&(s instanceof Array||(s=[s]),n.css(...s)),r&&(r instanceof Array||(r=p?[r,0]:[0,r]),n.shift_by(r))}let _=isNaN(c)?c:t=>t.toFixed(c),y=0;u||(u=1);for(let e=f;e<=g;e+=m){let a=p?[o,e]:[e,o];if(h&&i.line(s.plus(a),r.plus(a)),null!=c&&y++%u==0){let s=_(e),r=n.text(s,[...a,!1],t.theta);0==parseFloat(s)&&r.$.addClass("Zero")}}return d}plot(t,e,s,r){let i=this.group(".Plot","black@1","#0065fe");if(!(t instanceof Array)){let[e,s]=[t.x,t.y];e instanceof Array||(e=[...e]),s instanceof Function?s=[...fn_eval(s,e)]:s instanceof Array||(s=[...s]),t=zip(e,s)}for(let n of t){let t=i.group().config({theta:r,shift:n});e instanceof Function?e(t,s):s?t.image(s,e):e instanceof Array?t.rect(e):t.circle(e)}return i}error_bar_y(t,e,s,r,i){r=this.cs_radius(r);let n=this.group().addClass("ErrorBar");return i?(n.line([e,t],[s,t]),t-=r/2,n.line([e,t],[e,t+r]),n.line([s,t],[s,t+r])):(n.line([t,e],[t,s]),t-=r/2,n.line([t,e],[t+r,e]),n.line([t,s],[t+r,s])),n}error_bar_x(t,e,s,r){return this.error_bar_y(s,t,e,r,1)}edot(t,e){e||(e=1);let s=.25*e,r=[[-e,s],[-e,-s]];if(-1==t)t=2;else if(r=[[-e,0],[0,e],[e,0],[0,-e],[-e,0],[0,e],[e,0],[0,-e]],t>4)for(let e=0;e<t-4;e++)r[e][1-e%2]=s,r[e+4][1-e%2]=-s;let i=this.group({stroke:"none"});for(let s=0;s<t;s++)i.circle(.125*e,r[s]);return i}tip_to_tail(t,e){null==e&&(e={});let s=this.group(".TipToTail2D"),r=new RArray(0,0),i=Object.assign({tail:"7"},e);for(let e of t){let t=r,n=t.plus([e[0],0]);r=r.plus(e),(e[0]||e[1])&&(e[0]&&s.arrow({tail:t,tip:n},i).css(".Component"),e[1]&&s.arrow({tail:n,tip:r},i).css(".Component"),s.arrow({tail:t,tip:r},i))}if(t.length>1){if(r[0]&&r[1]){let t=[r[0],0];s.arrow({tail:[0,0],tip:t},i).$.addClass("Component Resultant"),s.arrow({tail:t,tip:r},i).$.addClass("Component Resultant")}s.arrow({tail:[0,0],tip:r},i).$.addClass("Resultant")}return s}energy_flow(t){SVG2.style(this.circle(t.radius),"none","#0065fe@3");let e=this.group("sans",24);for(let r of t.labels){let[t,i,n,a]=r,l="$"==(s=t).charAt(0)?s.substring(1):SVG2.eq[s]?SVG2.eq[s]:null;l&&"$"!=t.charAt(0)&&console.log(t,l),n||(n="#0065fe"),l?this.mjax(l,null,i,n):e.gtext(t,n,i)}var s;e=this.group("arrow");for(let e of t.arrows){let[t,s,r,i,n]=e;n||(n="#0065fe");let a=this.arrow(t,{tail:"6"}).css(n).config({theta:r,shift:s});i&&(i instanceof Array||(i=[i,[t>0?"-6":"6","12"]]),a.label(...i).css({stroke:"none"}))}return this}}class SVG2scaled extends SVG2group{constructor(t,e,s){super(t,e);let r=this.svg,i=t=>t.toFixed(r.decimals),[n,a]=r.a2p(0,0);n=i(n),a=i(a);let l=i(-n),o=i(-a),[h,c]=this.scale="number"==typeof s?[s,s]:s;this.$.attr({transform:`translate(${n} ${a}) scale(${h} ${c}) translate(${l} ${o}) `})}get pivot(){return new RArray(0,0)}get shift(){return new RArray(0,0)}get theta(){return 0}update_transform(){return this}coord_to_parent(t){let[e,s]=this.scale;return new RArray(t[0]*e,t[1]*s)}coord_from_parent(t){let[e,s]=this.scale;return new RArray(t[0]/e,t[1]/s)}}class SVG2text extends SVG2group{constructor(t,e,s,r,i){super(t);let n=null==s?[0,0]:[s[0],s[1]],a=SVG2.parse_anchor(s&&s.length>2?s[2]:"",1);this.config({shift:n,theta:r}).css(a),i instanceof Array?this.css(...i):i&&this.css(i);let l=this.svg,o=this.text$=this.create_child("text");o.html(e);let[h,c]=l.a2p(0,0),u=t=>t.toFixed(l.decimals);o.attr({x:u(h),y:u(c)})}get text(){return this.text$.html()}set text(t){this.text$.html(t)}}class SVG2arrow extends SVG2group{constructor(t,e,s,r){super(t),this.$.addClass("Arrow"),this.poly$=this.poly([],1),this.reshape(e,s,r)}reshape(t,e,s){let r=this.svg,[i,n]=(t=>{if("number"==typeof t)return[[-t/2,0],[t/2,0]];{let e=t.tail,s=t.tip;if(null==e&&(e=[0,0]),null==s){let r=t.angle;s=vec2d(t.length,r||0).plus(e)}return[e,s]}})(t);i=r.cs_size(i),n=r.cs_size(n);let a=this.seg=new Segment(...i,...n);s?"string"==typeof s&&(s=["tail","center","tip"].indexOf(s)-1):s=0,this.pivot=a[-1==s?"point1":1==s?"point2":"midpoint"];let l=t=>Math.abs("string"==typeof t?parseFloat(t):t*r.scale[1]),o={};e&&(o=Object.assign(o,e),o.tail&&(o.tail=l(o.tail)),o.head&&(o.head=l(o.head))),a=new Segment(...r.a2p(...i),...r.a2p(...n));let h=arrow_points(a.length,o);h=transform({angle:a.deg,deg:!0,shift:a.midpoint},...h);for(let t=0;t<h.length;t++)h[t]=r.p2a(...h[t]);return this.poly(h,this.poly$),this}label(t,e){return this.gtext(t,["sans","none@"],this.seg.midpoint.plus(this.cs_size(e)))}}class SVG2locus extends SVG2group{constructor(t,e,s,r){super(t);let i=this.svg=t.svg;this.eq=e,s||(s=[i.lrbt[0],i.lrbt[1]]),this.param=s.length>2?s:s.concat([i.$.width()/3]),this.args=r,this.poly$=$(this.css(".Locus").create_child("polyline")),this.update()}update(){SVG2group.prototype.update.call(this);let t=this.svg,e=t.time,[s,r]=[this.eq,this.args],[i,n,a]=this.param;a=(n-i)/Math.round(a),n+=a/2;let l=[];for(;i<=n;){let t=s(i,e,r);if(!1===t)return;l.push("number"==typeof t?[i,t]:t),i+=a}return this.poly$.attr({points:t.pts_str(l)}),this}}class SVG2path{constructor(t,e){this.g=t,this.svg=t.svg,this.$=t.create_child("path",{}),this.d="",this.move_to(null==e?[0,0]:e)}move_to(t,e){let s=this.svg,r=t=>t.toFixed(s.decimals),[i,n]=t;return this.x=i,this.y=n,[i,n]=s.a2p(...t),this.d+=`${e||"M"} ${r(i)} ${r(n)} `,this}line_to(t){return this.move_to(t,"L")}lines_to(...t){for(let e of t)this.line_to(e);return this}hor(t){let e=this.svg;return this.x=t,t=e.a2p(t,0)[0],this.d+=`H ${(t=>t.toFixed(e.decimals))(t)} `,this}ver(t){let e=this.svg;var s;return this.y=t,t=e.a2p(0,t)[1],this.d+=`V ${s=t,s.toFixed(e.decimals)} `,this}arc_to(t,e,s,r){let i,n,a=this.svg,l=t=>t.toFixed(a.decimals);e instanceof Array?[i,n]=e:i=n=e,[i,n]=a.px_size([i,n]),r=r?l(r*a.angleDir):"0";let[o,h]=t;this.x=o,this.y=h,[o,h]=a.a2p(o,h);let c=0,u=0;return s&&(c=1&s,u=2&s?1:0),this.d+=`A ${l(i)} ${l(n)} ${r} ${c} ${u} ${l(o)} ${l(h)} `,this}arc(t,e,s){let r=(t=new RArray(...t)).minus([this.x,this.y]).neg(),i=r.mag(),n=r.dir();null==s&&(s=Math.max(e,n)-Math.min(e,n)>=180?1:0,e<n&&(s+=2));let a=t.plus([i*cos(e),i*sin(e)]);return this.arc_to(a,i,s)}curve_to(t,e,s){let r=this.svg,i=t=>t.toFixed(r.decimals),[n,a]=t;this.x=n,this.y=a,[n,a]=r.a2p(n,a);let[l,o]=r.a2p(...e),[h,c]=r.a2p(...s);return this.d+=`C ${i(l)} ${i(o)}, ${i(h)} ${i(c)}, ${i(n)} ${i(a)} `,this}quad_to(t,e){let s=this.svg,r=t=>t.toFixed(s.decimals),[i,n]=t;this.x=i,this.y=n,[i,n]=s.a2p(i,n);let[a,l]=s.a2p(...e);return this.d+=`Q ${r(a)} ${r(l)}, ${r(i)} ${r(n)} `,this}close(){return this.d+="Z ",delete this.x,delete this.y,this}update(){return this.$.attr({d:this.d.trim()})}}class SVG2 extends SVG2group{constructor(t,e){super(),this.svg=this,this.element=$(t).filter("svg")[0],t=this.$=$(this.element).attr("xmlns",SVG2.nsURI),this.element.svg2=this,this.items=[],this._key_map={},this.decimals=2;let s=e.margin?e.margin:0;"number"==typeof s&&(s=[s,s,s,s]);let r=e.lrbt,i=e.scale;!i||i instanceof Array||(i=[i,i]);let[n,a]=e.size?e.size:i&&r.length>3?[i[0]*(r[1]-r[0])+s[0]+s[1]+1,i[1]*(r[3]-r[2])+s[2]+s[3]+1]:[t.width(),t.height()];if(n=Math.abs(Math.round(n)),a=Math.abs(Math.round(a)),t.attr({width:n,height:a,"data-aspect":n/a,viewBox:`0 0 ${n} ${a}`}),r){let[t,e,i,l]=s;r.length<4&&(r=SVG2.auto_lrbt(n-s[0]-s[1],a-s[2]-s[3],...r)),this.coords_by_map([t,a-1-i],[r[0],r[2]],[n-1-e,l],[r[1],r[3]])}else r=[0,n-1,0,a-1],this.coords_by_map([0,0],[0,0],[1,1],[1,1]),this.p2a=this.a2p=(t,e)=>new RArray(t,e);this.lrbt=r;let l=e.grid;if(l){let[t,s]="number"==typeof l?[l,l]:l,i=t*Math.round(r[0]/t),n=s*Math.round(r[2]/s),a=this.grid([i,r[1],t],[n,r[3],s],e.appendAxes);e.noAxes&&a.$.find(".Axis").removeClass("Axis").css(SVG2._style.grid)}this.playing=!1,this.frameRate=60,this.frameCount=0,this.timeFactor=1,this.time=0}static async sleep(t){await new Promise((e=>setTimeout(e,t)))}static make_URL(t){return new URL(t,SVG2.url).href}static parse_anchor(t,e){if(!1===t)return e?{}:null;let s=0;[s,t]=SVG2._parse_anchor(t),t.length&&(s+=SVG2._parse_anchor(t)[0]);let[r,i]=[3&s,(12&s)/4];if(e){let t={};return t["text-anchor"]=["middle","start","end"][r],t["dominant-baseline"]=["middle","auto","hanging"][i],t}return[1==r?0:2==r?1:.5,1==i?1:2==i?0:.5]}static _parse_anchor(t){let e=["left","right","bottom","top"],s=1;t=t.trim().toLowerCase();for(let r=0;r<e.length;r++){let i=e[r];if(t.substring(0,i.length)==i)return[s,t.substring(i.length)];if(t.charAt(0)==i.charAt(0))return[s,t.substring(1)];s*=2}return[0,t]}static*spring_points(t,e,s,r,i){let n=new Segment(...t,...e),a=n.length;r||(r=a/10),i||(i=a/10);let l=(a-2*r)/(2*s),o=n.normal.times(i);yield n.point(0);let h=r;for(let t=0;t<=s;t++)yield n.point(h).plus(o.times(t?t%2?1:-1:0)),h+=(t?2:1)*l;yield n.point(a-r),yield n.point(a)}static auto_lrbt(t,e,s,r,i,n){if(null==n){let a=(e-1)*(r-s)/(t-1);null==i?i=-(n=a/2):n=i+a}return[s,r,i,n]}get size(){let t=this.$;return[parseFloat(t.attr("width")),parseFloat(t.attr("height"))]}get center(){let[t,e,s,r]=this.lrbt;return new RArray((t+e)/2,(s+r)/2)}coords_by_map(t,e,s,r){let[i,n]=new RArray(...r).minus(e),[a,l]=new RArray(...s).minus(t),o=a/i,h=l/n,c=this.scale=new RArray(o,h);this.unit=Math.sqrt((o*o+h*h)/2),this.angleDir=o*h<0?-1:1;let u=new RArray(-1/o,-1/h);t=new RArray(...t).minus(c.times(e)),this.a2p=(e,s)=>t.plus(c.times([e,s])),this.p2a=(e,s)=>t.minus([e,s]).times(u)}event_coords(t){let e=this.$,s=parseFloat(e.css("padding-left"))+parseFloat(e.css("border-left-width")),r=parseFloat(e.css("padding-top"))+parseFloat(e.css("border-top-width")),i=this.element.getBoundingClientRect(),n=new RArray(t.clientX-(i.x+s),t.clientY-(i.y+r));return n[0]*=parseFloat(e.attr("width"))/e.width(),n[1]*=parseFloat(e.attr("height"))/e.height(),{pixels:n,coords:this.p2a(...n)}}adjust_angle(t,e){let[s,r]=this.scale;return e&&(s=1/s,r=1/r),atan2(r*this.angleDir*sin(t),s*cos(t))}clip_rect(t,e){null==t&&(t=0),t=(t instanceof Array?this.cs_size(t):this.cs_size([t,t])).times(2);let s=this.group(),[r,i,n,a]=this.lrbt;return s.rect([Math.abs(i-r)+t[0],Math.abs(a-n)+t[1]],this.center),s.clip_path(e||"lrbt"),this}get url(){return"data:image/svg+xml;base64,"+unicode_to_base64(this.element.outerHTML)}static async cleanup_svg(t,e){let s=(t=$(t).removeAttr("class style"))[0].attributes,r=[];for(let t=0;t<s.length;t++){let e=s.item(t);"data"==e.name.split("-")[0]&&r.push(e.name)}for(let e of r)t.removeAttr(e);if(e){t.appendTo("body"),$(document.createElementNS(SVG2.nsURI,"rect")).prependTo(t).attr({x:0,y:0,width:t.width(),height:t.height(),style:`fill: ${e}`}),t.remove()}let i=[],n=[];for(let e of t.find("image")){let t=$(e).attr("href");"data:"!=t.substring(0,5)&&(n.push(e),i.push(t))}return load_dataURLs(...i).then((e=>{for(let t=0;t<i.length;t++){let s=e[i[t]];$(n[t]).attr({href:s})}return t[0]}))}static async svg_to_cv(t,e){return load_img("data:image/svg+xml;base64,"+unicode_to_base64(t.outerHTML)).then((t=>{let s=$(t).appendTo("body"),r=img2canvas(t,e);return s.remove(),r}))}async image_cv(t,e){return SVG2.cleanup_svg(this.element.outerHTML,e).then((e=>SVG2.svg_to_cv(e,t)))}async save(t){return SVG2.cleanup_svg(this.element.outerHTML).then((t=>blobify(t.outerHTML,"image/svg+xml"))).then((e=>e.save(t)))}async save_image(t,e,s){1==t&&(t=`${random_string(12,1)}.png`);let r=t?t.split(".").item(-1).toLowerCase():"png";return"jpg"==r&&(r="jpeg"),this.image_cv(e,s).then((t=>blobify(t,"image/"+r))).then((e=>e.save(t)))}get defs(){let t=this.$.find("defs");return 0==t.length&&(t=this.create_child("defs").prependTo(this.$)),t}gradient(t,e,s,r,i,n,a){let l=(t,e)=>{let s=document.createElementNS(SVG2.nsURI,t);return null!=e&&$(s).attr(e),s},o=$(l("linearGradient",{id:t,x1:`${null==r?0:r}%`,x2:`${null==i?100:i}%`,y1:`${null==n?0:n}%`,y2:`${null==a?0:a}%`})).appendTo(this.defs[0]);return o.append(l("stop",{offset:"0%","stop-color":e})),o.append(l("stop",{offset:"100%","stop-color":s})),this}static create(t){return new SVG2(document.createElementNS(SVG2.nsURI,"svg"),t)}update_transform(){return this}group(...t){let e=new SVG2group(this);return t&&e.css(...t),e}pts_str(t){let e="",s=t=>t.toFixed(this.decimals);for(let r=0;r<t.length;r++){let[i,n]=this.a2p(...this.cs_size(t[r]));e+=(e.length?" ":"")+`${s(i)},${s(n)}`}return e}static style(t,...e){let s=t=>isNaN(t)?t:`${t}px`;for(let r of e){let e=["string","number"].indexOf(typeof r);-1==e?t.css(r):0==e?"."==r.charAt(0)?t.addClass(r.substring(1)):SVG2._style[r]?t.css(SVG2._style[r]):(r=r.split("@"),1==r.length?t.css({fill:r[0]}):(r[0]&&t.css({stroke:r[0]}),r[1]&&t.css({"stroke-width":s(r[1])}))):1==e&&t.css({"font-size":s(r)})}return t}static set_animated(t,e){let s=t.svg,r=s.items,i=r.indexOf(t);e?-1==i&&s.animate(t):i>-1&&r.splice(i,1)}animate(...t){for(let e of t)e.update||(e=$(e)[0]._gr),-1==this.items.indexOf(e)&&this.items.push(e);return this}unanimate(...t){let e=this.items;for(let s=e.length-1;s>=0;s--)t.indexOf(e[s])>-1&&e.splice(s,1);return this}update(t){clearTimeout(this._animate);let e=null==t;e&&(t=this.timeFactor/this.frameRate),this.beforeupdate&&this.beforeupdate.call(this);for(let e of this.items)try{e.beforeupdate&&e.beforeupdate(),e.update(t),e.afterupdate&&e.afterupdate()}catch(t){console.warn(t)}this.time+=t,t=1e3/this.frameRate;let s=this._nextFrame-Date.now();return s<=0?(s=1,this._nextFrame=Date.now()+t-1):this._nextFrame+=t,e&&this.frameCount++,this.afterupdate&&this.afterupdate.call(this),this.playing&&(this._animate=setTimeout((()=>{this.update()}),s)),this}play(){return this.playing=!0,this._nextFrame=Date.now()+1e3/this.frameRate,this._fpsDebug&&(this._fpsDebug=[this.frameCount,Date.now()]),this.update()}pause(){if(clearTimeout(this._animate),this.playing=!1,this._fpsDebug){let[t,e]=this._fpsDebug;t=this.frameCount-t,e=(Date.now()-e)/1e3,console.log(`${t} frames / ${e} sec = ${t/e} fps`)}return this}toggle(){return this.playing?this.pause():this.play()}click_toggle(t,e,s,r,...i){i||(i=[]),i.push(!1);for(let e=0;e<t;e++)i.push((()=>{let t=e-1;r&&e&&click_cycle.toggle(this,!1,t),click_cycle.toggle(this,!0,e)}));for(let e=0;e<i.length;e++){let s=i[e];!0!==s&&!1!==s||(i[e]=()=>click_cycle.toggle(this,s,...range(t)))}if(click_cycle(this.element,null==s?-1:s,...i),e)for(let t=0;t<e;t++)this.$.trigger("click");return this}static vec_diag(t,e,s){let r=new SVG2(t,s);s||(s={});let i=r.tip_to_tail(e);if(s.shift&&i.config({shift:s.shift}),s.label){let[t,e,i,n]=s.label,[a,l,o,h]=r.lrbt;a=t*Math.ceil(a/t),o=t*Math.ceil(o/t);let c={size:["-6",0],css:["mono",14],label:e,shift:"-8"};s.tick&&(c=Object.assign(c,s.tick)),r.ticks({x:[a,l+t/10,t],...c}).shift_by([0,n||0]),r.ticks({y:[o,h+t/10,t],...c}).shift_by([i||0,0])}return i.$.appendTo(r.$),r.$.find(".Zero").hide(),-1==s.cycle?i.$.find(".Component").hide():s.cycle&&r.vec_cycle(i.$,e.length>1),i.$.find(".Arrow").css(SVG2._style.arrow),i.$.find(".Resultant").css({fill:"#0065fe"}),i.$.find(".Component").css({fill:"yellow"}),r}vec_cycle(t,e){return t.find(".Component").hide(),e?click_cycle(this.element,0,(()=>{t.find(".Component").fadeOut()}),(()=>{t.find(".Resultant").fadeOut(),t.find(".Component:not(.Resultant)").fadeIn()}),(()=>{t.find(".Component:not(.Resultant)").fadeOut(),t.find(".Component.Resultant").fadeIn()}),(()=>{t.find(".Resultant").fadeIn()})):this.$.on("click",(()=>t.find(".Component").fadeToggle())),this}static vec_diag_table(t,e,s,r){let i=$("<table>").addClass("VectorTable"),n=$("<thead>").appendTo(i),a=$("<tr>").appendTo(n),l="Δ"==t.charAt(0)?`\\Delta\\vec{\\bf ${t.substring(1)}}`:`\\vec{\\bf ${t}}`;for(let t of[`|${l}|`,"\\theta",`${l}_x`,`${l}_y`])a.append($("<th>").addClass("TeX").html(t));a=$("<tr>").appendTo(n);for(let t of[`\\sqrt{(${l}_x)^2 + (${l}_y)^2}`,`\\tan^{-1}\\frac{${l}_y}{${l}_x}`,`|${l}| \\cos\\theta`,`|${l}| \\sin\\theta`])a.append($("<th>").html($("<p>").html(t).addClass("TeX")));let o=$("<tbody>").appendTo(i),h=new RArray(0,0);for(let t of e)r&&(t=new RArray(...t).times(r)),h=h.plus(t),o.append(new RArray(...t).tr(s||4));return o.append(new RArray(...h).tr(s||4).addClass("Resultant")),renderTeX(n.find(".TeX")),i}static ebg(t,e,s,r,i){i=Object.assign({size:[512,384],width:.5,duration:0,unit:"J",margin:[32,4,44,16]},i);let n=r.length,a=new SVG2(t,{size:i.size,lrbt:[0,n,0,e],margin:i.margin});a.grid([0,n],[0,e+s/2,s]).grid([0,1,2],[0,e]);let l=[],o=a.group(".MJax");for(let t=0;t<n;t++){let e=r[t],s=e[2]?e[2]:"#0065fe";l.push(a.rect([i.width,1],[t+.5,1]).css({fill:s}));let n=e[0];SVG2.eq[n]&&(n=SVG2.eq[n]),o.mjax(n,null,[[t+.5,"-8"],[.5,0]],s)}if(a.config({data:r,options:i}),a.$.find("g.Grid line.Axis").appendTo(a.$),i.E&&css(a.line([0,i.E],[n,i.E]),".TotalEnergy","black@2"),i.label){let t=["sans",16],[r,n,l]=i.label;a.ticks({x:n,y:[0,e+s/2,l?l*s:s],label:r,css:t}),i.unit&&a.gtext(i.unit,t,["6",e,"l"])}return a.beforeupdate=function(){let t=this.time,e=this.options;if(e.duration&&t>e.duration)this.pause(),this.time=e.duration;else{let s=0,r=0,i=e.width,n=l.length;e.duration&&(t/=e.duration);for(let e=0;e<n;e++){let n=this.data[e][1];if(!0===n)r+=1;else{let r="number"==typeof n?n:n(t);s+=r,a.rect([i,r],[e+.5,r/2],l[e])}}let o=(e.E-s)/r;for(let t=0;t<n;t++){!0===this.data[t][1]&&a.rect([i,o],[t+.5,o/2],l[t])}}},a.$.on("click",(()=>{a.time>=a.options.duration&&!a.playing?(a.time=0,a.update(0)):a.toggle()})),a.update(0)}}SVG2.nsURI="http://www.w3.org/2000/svg",SVG2.url=location.href.split("#")[0],SVG2.serif="'Noto Serif', 'Open Serif', 'Droid Serif', serif",SVG2.sans="'Noto Sans', 'Open Sans', 'Droid Sans', Oxygen, sans-serif",SVG2.mono="'Noto Sans Mono', Inconsolata, 'Droid Sans Mono', monospace",SVG2._style={grid:{stroke:"lightgrey","stroke-width":"0.5px"},arrow:{fill:"red",stroke:"black","stroke-width":"0.5px","fill-opacity":.8},ital:{"font-style":"italic"},bold:{"font-weight":"bold"},sans:{"font-family":SVG2.sans,"font-size":"18px"},serif:{"font-family":SVG2.serif,"font-size":"18px"},mono:{"font-family":SVG2.mono,"font-size":"18px"}},SVG2.eq={Ek:"E_k",Eg:"E_g"};