/*(c) 2023-2025 by D.G.MacCarthy*/Array.prototype.item=function(t){return this[t<0?t+this.length:t]};const sleep=async t=>await new Promise((e=>setTimeout(e,t)));function jeval(t){return JSON.parse(`{"a": ${t}}`).a}function jeval_frac(t){return jeval((t=t.split("/"))[0])/(t.length>1?jeval(t[1]):1)}function click_cycle(t,e,...r){t.cycleStatus=e,$(t).click((e=>{let i=e.ctrlKey,s=r.length;t.cycleStatus+=i?-1:1,t.cycleStatus<0?t.cycleStatus=s-1:t.cycleStatus>=s&&(t.cycleStatus=0);let n=i?0:t.cycleStatus;for(;n<=t.cycleStatus;)r[n++]()}))}function*range(t,e,r){for(null==e&&(e=t,t=0),r||(r=t<e?1:-1);r>0&&t<e||r<0&&t>e;)yield t,t+=r}function file_ext(t){let e=(t=new URL(t,location.href)).pathname.split("/");return e=e.item(-1).split("."),e.item(-1).toLowerCase()}function qs_args(t,e){let r={};for(let[t,i]of new URLSearchParams(e||location.search))r[t]=i;return t?r[t]:r}function item_aspect(t,e){let r=jeval_frac((t=$(t)).attr("data-aspect"));if(e){t.css({width:""});let e=Math.round(t.height()*r);e!=t.width()&&t.width(e)}else{t.css({height:""});let e=Math.round(t.width()/r);e!=t.height()&&t.height(e)}}function aspect(t){let e=$("[data-aspect]");for(let r=0;r<e.length;r++)item_aspect(e[r],t)}function is_after(t,e){return null==t||0!=t&&(null==e&&(e=new Date),t instanceof Date||((t=t.split(".")).length>1&&(t[1]=parseInt(t[1])-1),t=new Date(...t)),e>=t)}function random_string(t,e){let r="";for(2==e&&(r=random_string(1),t--);t--;){let t=Math.floor((e?62:52)*Math.random());t=(t<26?65:t<52?97:48)+t%26,r+=String.fromCharCode(t)}return r}function random_color(t){let e="#";t||(t=6);for(let r=0;r<t;r++){let t=Math.floor(15.9999*Math.random());e+="0123456789abcdef".charAt(t)}return e}function*_zip(t,e,r){let i=t instanceof Array,s=e instanceof Array,n=i?t.length:e.length;for(let a=0;a<n;a++){let n=i?t[a]:t,l=s?e[a]:e;yield r?new RArray(n,l):[n,l]}}function zip(t,e,r){return[..._zip(t,e,r)]}function unzip(t,e){let r=t[0].length,i=new Array(r);for(let t=0;t<i.length;t++)i[t]=e?new RArray:[];for(let e=0;e<t.length;e++)for(let s=0;s<r;s++)i[s].push(t[e][s]);return i}function unicode_to_base64(t){let e=(new TextEncoder).encode(t);return btoa(String.fromCharCode(...e))}function katex_render(t,e){t=$(t||".TeX").removeClass("TeX");for(let r of t){let t=$(r),i=t.text();t.attr("data-latex",i);let s={displayMode:t.is("p, div, .Display"),throwOnError:!1};e&&Object.assign(s,e),katex.render(i,r,s)}katex_render.hideEqNum&&$("[data-latex]:is(p, div) .eqn-num").hide()}async function mjax_render(t,e){t=$(t||".TeX").addClass("TeX_Pending").removeClass("TeX");let r=[];for(let i of t){let t=$(i),s=t.text();t.attr("data-latex",s),f=e?t=>$(t):t=>$(t).find("svg"),r.push(MathJax.tex2svgPromise(s).then((e=>t.removeClass("TeX_Pending").html(f(e)[0]))))}return new Promise((async t=>{for(let t=0;t<r.length;t++)await r[t];t()}))}async function mjax_wait(t){for(;!MathJax.typesetPromise;)await sleep(t||50);return new Promise((t=>t(0)))}async function mjax_svg(t){return MathJax.tex2svgPromise(t).then((t=>$($(t).find("svg")[0])))}async function mjax_url(t){return mjax_svg(t).then((t=>"data:image/svg+xml;base64,"+unicode_to_base64(t[0].outerHTML)))}function mjax_img(t){return mjax_url(t).then((t=>$("<img>").attr({src:t})))}async function load_img(t){return new Promise((e=>{let r=new Image;r.addEventListener("load",(()=>e(r))),r.src=t}))}async function blobify(t,...e){return new Promise((r=>{if(t instanceof Blob)t.save=blobify._save,r(t);else if(t.toBlob)t.toBlob((t=>{t.save=blobify._save,r(t)}),...e);else{let i=new Blob([t],{type:e.length?e[0]:"text/plain"});i.save=blobify._save,r(i)}}))}function img2canvas(t,e){if(e||(e=1),!(e instanceof Array)){let r=$(t);e=[Math.round(e*r.width()),Math.round(e*r.height())]}let[r,i]=e;if(r*i==0)throw"Image has a dimension of 0";let s=$("<canvas>").attr({width:r,height:i})[0];return s.getContext("2d").drawImage(t,0,0,r,i),s}async function load_one_blob(t,e){return new Promise(((r,i)=>{fetch(t).then((t=>t.blob().then((s=>{if(t.ok)if(e){const t=new FileReader;t.onloadend=t=>r(t.target.result),t.readAsDataURL(s)}else r(s);else i(s)}))))}))}async function _load_blobs(t,...e){let r={},i={};for(let s of e)i[s]=load_one_blob(s,t).then((t=>r[s]=t),(()=>r[s]=null));for(let t of e)await i[t];return new Promise((t=>{t(r)}))}async function load_blobs(...t){return _load_blobs(0,...t)}async function load_dataURLs(...t){return _load_blobs(1,...t)}function code_echo(t,e){let r=t.text();if(e){let i=t.attr("data-echo"),s=i.split(".").pop();i==s&&(i=random_string(12,1)+"."+s),"html"!=s&&"htm"!=s||(-1==r.search("</body>")&&(r=`<body>\n${r}\n</body>`),-1==r.search("</head>")&&(r=`${code_echo.head}\n${r}\n`),-1==r.search("</html>")&&(r=`${code_echo.html}\n${r}\n</html>`)),blobify(r,blobify.mime(s)).then((t=>t.save(2==e?i:null)))}else navigator.clipboard.writeText(r).then((()=>msg("Text copied to clipboard")),(()=>msg("Unable to copy text")))}function RGBtoHSV(t,e,r){let i,s=Math.max(t,e,r),n=Math.min(t,e,r),a=s/2.55,l=s-n,o=0===s?0:100*l/s;switch(s){case n:i=0;break;case t:i=e-r+l*(e<r?6:0),i/=6*l;break;case e:i=r-t+2*l,i/=6*l;break;case r:i=t-e+4*l,i/=6*l}return{h:360*i,s:o,v:a}}function HSVtoRGB(t,e,r){return uHSVtoRGB(t/360,e/100,r/100)}function uHSVtoRGB(t,e,r){let i,s,n,a,l,o,h,c;switch(a=Math.floor(6*t),l=6*t-a,o=r*(1-e),h=r*(1-l*e),c=r*(1-(1-l)*e),a%6){case 0:i=r,s=c,n=o;break;case 1:i=h,s=r,n=o;break;case 2:i=o,s=r,n=c;break;case 3:i=o,s=h,n=r;break;case 4:i=c,s=o,n=r;break;case 5:i=r,s=o,n=h}return{r:Math.round(255*i),g:Math.round(255*s),b:Math.round(255*n)}}click_cycle.toggle=(t,e,...r)=>{let i;try{i=t instanceof SVG2?t:null}catch(t){}for(let s of r){let r=i?i.$.find(`.Toggle${s}`):$(t[s]);e?r.fadeIn():null==e?r.fadeToggle():r.fadeOut()}},katex_render.hideEqNum=!0,renderTeX=mjax_render,blobify._save=function(t){let e=URL.createObjectURL(this);t?$("<a>").attr({href:e,download:t})[0].click():window.open(e),URL.revokeObjectURL(e)},blobify.mime=t=>{let e={html:"text/html",htm:"text/html",js:"text/javascript",css:"text/css",csv:"text/csv",py:"text/python",svg:"image/svg+xml",png:"image/png",jpg:"image/jpeg",webp:"image/webp",json:"application/json",xml:"application/xml",pdf:"application/pdf",zip:"application/zip"}[t.split(".").pop().toLowerCase()];return e||"text/plain"},code_echo.html='<!DOCTYPE html>\n<html lang="en-ca">',code_echo.head='<head>\n<meta charset="utf8"/>\n<meta name="viewport" content="width=device-width, initial-scale=1"/>\n<title>HTML Document</title>\n<link rel="shortcut icon" type="image/svg+xml" href="https://upload.wikimedia.org/wikipedia/commons/6/61/HTML5_logo_and_wordmark.svg"/>\n</head>';const pi=Math.PI,DEG=pi/180,RAD=180/pi,twoPi=2*pi,halfPi=pi/2,quarterPi=pi/4;class RArray extends Array{static add(...t){let e=new RArray,r=t[0].length;for(let i=0;i<r;i++){let r=0;for(let e=0;e<t.length;e++)r+=t[e][i];e.push(r)}return e}static convert(...t){let e=[];for(let r of t)e.push(new RArray(...r));return e}sum(){let t=this.length,e=0;if(t){e=this[0];for(let r=1;r<t;r++)e+=this[r]}return e}minmax(){let t=this[0],e=t;for(let r=0;r<this.length;r++)this[r]<t&&(t=this[r]),this[r]>e&&(e=this[r]);return{min:t,max:e}}extend(t){return this.push.apply(this,t),this}remove(t,e){let r=!0;for(;r;){let i=this.indexOf(t);i>=0&&this.splice(i,1),-1!=i&&e||(r=!1)}return this}times(t){let e=t instanceof Array,r=new RArray;for(let i=0;i<this.length;i++)r.push(this[i]*(e?t[i]:t));return r}neg(){return this.times(-1)}plus(t){return RArray.add(this,t)}minus(t){let e=new RArray;for(let r=0;r<this.length;r++)e.push(this[r]-t[r]);return e}dot(t){let e=0;for(let r=0;r<this.length;r++)e+=this[r]*t[r];return e}mag(){return Math.sqrt(this.dot(this))}dir(){if(2!=this.length)throw"ValueError: operation applies only to arrays of length 2";return atan2(this[1],this[0])}tr(t,e){t||(t=4);let r=$("<tr>"),i=[this.mag(),this.dir(),this[0],this[1]];for(let s of i)e&&(s*=e),r.append($("<td>").html(s.toPrecision(t)));return r}}function xy_limits(...t){let e=new RArray(0,0),r=[e];for(let i of t)e=e.plus(i),r.push(e);let[i,s]=unzip(r,!0);return i=i.minmax(),s=s.minmax(),{x:i,y:s,center:[(i.min+i.max)/2,(s.min+s.max)/2],size:[i.max-i.min,s.max-s.min]}}function*fn_eval(t,e){for(let r of e)yield t(r)}function uniform(t,e){return t+(e-t)*Math.random()}function randint(t,e){return null==e&&(e=t,t=0),t+Math.floor((e+1-t)*Math.random())}function shuffle(t){for(let e=t.length-1;e>0;e--){let r=randint(e+1);[t[e],t[r]]=[t[r],t[e]]}}function number_HTML(t,e){let r=this.toPrecision(t).toLowerCase().split("e"),i=r[1];return i=r[0]+(r.length>1?e?`\times 10^{${i}}`:` × 10<sup>${i}</sup>`:""),e||(i=i.replace("-","–")),i}function arrow_points(t,e){e||(e={});let r=(e.angle?e.angle:35)*DEG,i=e.tail?e.tail:t/14;i<0&&(i*=-t);let s=e.head?e.head:4*i,n=Math.cos(r),a=Math.sin(r),l=i/2,o=-s*n,h=o-i*a,c=s*a,u=c-i*n,d=h-(l-u)*n/a;(d<h||2==e.shape)&&(d=h),u<l&&(u=l);let f=RArray.convert([0,0],[o,c],[h,u],[d,l],[-t,l],[-t,-l],[d,-l],[h,-u],[o,-c]);(e.shape||c<l)&&(f.splice(8,1),f.splice(1,1)),t/=2;for(let e=0;e<f.length;e++)f[e][0]+=t;if(e.double){let t=Math.floor(f.length/2),e=f.slice(0,t),r=t=>{let[e,r]=f[t];return new RArray(-e,r)};for(let i=0;i<t;i++)e.push(r(t-1-i));t=e.length-2,r=t=>{let[r,i]=e[t];return new RArray(r,-i)};for(let i=t;i>0;i--)e.push(r(i));f=e}return f}function star_points(t,e,r){return r||(r=3*e/7),[...fn_eval((i=>vec2d(i%2?r:e,90*(1+2*i/t))),range(0,2*t))]}function sq(t){return t*t}function root(t,e){return Math.pow(t,1/(null==e?2:e))}function sin(t){return Math.sin(t*DEG)}function cos(t){return Math.cos(t*DEG)}function tan(t){return Math.tan(t*DEG)}function asin(t){return Math.asin(t)*RAD}function acos(t){return Math.acos(t)*RAD}function atan(t){return Math.atan(t)*RAD}function atan2(t,e){return Math.atan2(t,e)*RAD}function hypot(t,e){return Math.sqrt(t*t+e*e)}const log=(t,e)=>(t=Math.log(t),e?t/Math.log(e):t),vec2d=(t,e,r)=>(r||(e*=DEG),new RArray(t*Math.cos(e),t*Math.sin(e))),vec=(...t)=>new RArray(...t),adjust_angle=(t,e,r)=>{for(null==e&&(e=0),null==r&&(r=e+360);t<e;)t+=360;for(;t>=r;)t-=360;return t};class Segment{constructor(t,e,r,i){null==r&&(r=t,i=e,t=e=0);let s=r-t,n=i-e,a=Math.sqrt(s*s+n*n),l=new RArray(s/a,n/a),o=Math.atan2(n,s),h=this;Object.assign(this,{point1:new RArray(t,e),point2:new RArray(r,i),length:a,rad:o,deg:o*RAD,slope:l[1]/l[0],midpoint:new RArray(t+s/2,e+n/2),unitVector:l,vector:new RArray(s,n),normal:new RArray(-l[1],l[0]),point:r=>new RArray(t+l[0]*r,e+l[1]*r),params:(r,i)=>{let s=(r-t)*l[0]+(i-e)*l[1],n=(t-r)*l[1]+(i-e)*l[0];return new RArray(s,n)},closest:(r,i)=>h.point((r-t)*l[0]+(i-e)*l[1])})}static point_slope(t,e,r,i){let[s,n]=Math.abs(r)==1/0?new RArray(0,r<0?-e:e):new RArray(1,r).times(e/hypot(1,r)),[a,l]=i?new RArray(-s/2,-n/2).plus(t):t;return new Segment(a,l,a+s,l+n)}}function _SSS(t,e,r){return acos((r*r-t*t-e*e)/(-2*t*e))}function SSS(t,e,r){return[_SSS(e,r,t),_SSS(t,r,e),_SSS(t,e,r)]}function SAS(t,e,r){let i=root(t*t+r*r-2*t*r*cos(e)),s=_SSS(r,i,t);return[s,i,180-(s+e)]}function ASA(t,e,r){let i=180-(t+r);return[(e/=sin(i))*sin(t),i,e*sin(r)]}function SSA(t,e,r,i){let s=asin(e*sin(r)/t);i&&(s=180-s);let n=180-(r+s);if(n>=0)return[root(t*t+e*e-2*t*e*cos(n)),n,s]}function quad_form(t,e,r){return[(-e+root(e*e-4*t*r))/(2*t),(-e-root(e*e-4*t*r))/(2*t)]}const transform=(t,...e)=>{let r=t.angle?t.angle:0;t.deg&&(r*=DEG);let i=Math.cos(r),s=Math.sin(r),n=0,a=0;t.center&&(n=t.center[0],a=t.center[1]);let l=n,o=a;t.shift&&(l+=t.shift[0],o+=t.shift[1]);let h=[];for(let t=0;t<e.length;t++){let r=e[t][0]-n,c=e[t][1]-a;h.push(new RArray(r*i-c*s+l,r*s+c*i+o))}return h};function lin_reg_xy(t,e){let r=t.length;if(e.length!=r)throw"Dimension error";t=new RArray(...t),e=new RArray(...e);let i=t.sum(),s=e.sum(),n=(r*t.dot(e)-i*s)/(r*t.dot(t)-i*i),a=(s-n*i)/r;return{m:n,b:a,fn:t=>n*t+a}}function exp_reg_xy(t,e){let r=e.length,i=new Array(r);for(let t=0;t<r;t++)i[t]=Math.log(e[t]);let s=lin_reg_xy(t,i),n=Math.exp(s.b),a=s.m;return{a:n,k:a,fn:t=>n*Math.exp(a*t)}}function pwr_reg_xy(t,e){let r=t.length,i=new Array(t),s=new Array(r);for(let n=0;n<r;n++)i[n]=Math.log(t[n]),s[n]=Math.log(e[n]);let n=lin_reg_xy(i,s),a=Math.exp(n.b);return r=n.m,{a:a,n:r,fn:t=>a*Math.pow(t,r)}}function lin_reg(...t){return lin_reg_xy(...unzip(t))}function exp_reg(...t){return exp_reg_xy(...unzip(t))}function pwr_reg(...t){return pwr_reg_xy(...unzip(t))}function gcf(t,e){let r=parseInt(t),i=parseInt(e);if(t!=r||e!=i||isNaN(r)||isNaN(i)||t<1||e<1)throw"Invald argument";if([t,e]=[Math.min(r,i),Math.max(r,i)],e%t==0)return t;let s=1,n=2;for(;2*n<=t;)t%n==0&&e%n==0&&(s=n),n++;return s}function lcm(t,e){return Math.round(t/gcf(t,e)*e)}class SVG2g{constructor(t,e){t&&(this.element=e?$(e)[0]:document.createElementNS(SVG2.nsURI,"g"),this.element.graphic=this,this.$=$(this.element),this.$.appendTo(e?e.$:t.$),this.svg=t.svg,this._pivot=new RArray(0,0),this._shift=new RArray(0,0),this._vel=new RArray(0,0),this._acc=new RArray(0,0),this.thetaMode=1,this._theta=0,this.omega=0,this.alpha=0)}find(t,e){let r=this.$.find(t)[e||0];return r?r.graphic:null}find_all(t){let e=[];for(let r of this.$.find(t))r.graphic instanceof SVG2g&&e.push(r.graphic);return e}config(t){for(let e in t)this[e]=t[e];return this.update_transform()}addClass(...t){return this.$.addClass(...t),this}css(...t){return SVG2.style(this.$,...t),this}ralign(t,e){let r,i,s=this.svg,n=this.element.getBBox(),[a,l]=[n.width,n.height];a*l==0&&console.warn("Aligning group with 0 width or height:",this),[a,l,r,i]=this.rect_xy([a.toFixed(2),l.toFixed(2)],t),"x"==e?i=n.y:"y"==e&&(r=n.x);let[o,h]=new RArray(r,i).minus([n.x,n.y]);return this.shift_by([o/s.scale[0],h/s.scale[1]]),this.update_transform()}align(t,e,r){let i=this.element.getBBox(),[s,n]=[i.width,i.height];s*n==0&&console.warn("Aligning group with 0 width or height:",this),"number"==typeof t&&(t=[t,t]),null==r&&(null==e?e=r=.5:"string"==typeof e&&([e,r]={top:[.5,0],bottom:[.5,1],left:[0,.5],right:[1,.5]}[e]));let a=null==e,l=null==r,o=this.svg.p2a(i.x+(a?0:e)*s,i.y+(l?0:r)*n).plus(this._shift);return o=this._cs(t).minus(o),a&&(o[0]=0),l&&(o[1]=0),this._shift=this._shift.plus(o),this.update_transform()}get pivot(){return this._pivot}get shift(){return this._shift}get vel(){return this._vel}get acc(){return this._acc}get theta(){return this._theta}set pivot(t){this._pivot=new RArray(...this._cs(t))}set shift(t){this._shift=new RArray(...this._cs(t))}set vel(t){this._vel=new RArray(...this._cs(t))}set acc(t){this._acc=new RArray(...this._cs(t))}set theta(t){if(this.thetaMode){for(;t>=360;)t-=360;for(;t<0;)t+=360}this._theta=t}shift_by(t){return this._shift=this._shift.plus(this._cs(t)),this.update_transform()}clip_path(t,e){let r=this.$,i=$(document.createElementNS(SVG2.nsURI,"clip_path")).attr({id:t});i.appendTo(this.svg.defs[0]),e?i.html(r.html()):r.children().appendTo(i);let s=r.attr("transform");return s&&i.children().attr({transform:s}),i}clip(t){return this.$.attr({"clip-path":`url(#${t})`}),this}get parent(){let t=this.$.parent().closest("g, svg");return t.length?t[0].graphic:null}gpath(){let t=this.parent,e=[this];return t?t.gpath().concat(e):e}coord_from_parent(t){let e=this.theta*this.svg.angleDir;return t=this._shift.neg().plus(t),transform({angle:e,deg:!0,center:this._pivot},t)[0]}coord_to_parent(t){let e=this.theta*this.svg.angleDir;return transform({angle:-e,deg:!0,center:this._pivot,shift:this._shift},t)[0]}coord_to_svg(t){let e=this;for(;e.parent;)t=e.coord_to_parent(t),e=e.parent;return t}coord_from_svg(t){let e=this.gpath();for(let r=1;r<e.length;r++)t=e[r].coord_from_parent(t);return t}update_transform(){let t=this.svg,e=this.theta*t.angleDir,[r,i]=t.scale.times(this.shift),s=e=>e.toFixed(t.decimals),n=r||i?`translate(${s(r)} ${s(i)})`:"";if(e){let[r,i]=t.a2p(...this.pivot);n+=` rotate(${s(e)} ${s(r)} ${s(i)})`}return n=n.trim(),n.length?this.$.attr("transform",n):this.$.removeAttr("transform"),this}update(t){let e=this.alpha,r=this.omega;e&&(this.omega+=t*e,r+=t/2*e),r&&(this.theta=this.theta+t*r);let i=this._vel,s=this._acc;if(i||s){let e=s.times(t/2);i=i.plus(e),this._vel=i.plus(e),this._shift=this._shift.plus(i.times(t))}return this.update_transform()}get animated(){return this.svg.items.indexOf(this)>-1}set animated(t){SVG2.set_animated(this,t)}create_child(t,e){return $(document.createElementNS(SVG2.nsURI,t)).attr(e||{}).appendTo(this.element)}group(...t){let e=new SVG2g(this.svg,this.create_child("g"));return t&&e.css(...t),e}scaled(t){return new SVG2scaled(this.svg,this.create_child("g"),t)}_px(t,e){return Math.abs("string"==typeof t?parseFloat(t):t*this.svg.scale[e])}_cs(t){let[e,r]=null==t?[0,0]:t,i=this.svg,[s,n]=i.scale;return"string"==typeof e&&(e=parseFloat(e)/Math.abs(s)),"string"==typeof r&&(r=parseFloat(r)/Math.abs(n)),new RArray(e,r)}circle(t,e,r){let i=r?$($(r)[0]):this.create_child("circle"),s=this.svg,n=t=>t.toFixed(s.decimals),a=`${n(2*(t=s._px_size(t)))}`,[l,o,h,c]=this.rect_xy([a,a],e);return i.attr({r:n(t),cx:n(h+l/2),cy:n(c+o/2)})}ellipse(t,e,r){let i=r?$($(r)[0]):this.create_child("ellipse"),s=this.svg,n=t=>t.toFixed(s.decimals),a=this._px(t[0],0),l=this._px(t[1],1),[o,h,c,u]=this.rect_xy([n(2*a),n(2*l)],e);return i.attr({rx:n(a),ry:n(l),cx:n(c+o/2),cy:n(u+h/2)})}static _anchor(t){return null==t&&(t=[0,0]),4==t.length?t:t[0]instanceof Array?[...t[0],...t[1]]:[...t,.5,.5]}rect_xy(t,e){let[r,i,s,n]=SVG2._anchor(e),a=this.svg,l=this._px(t[0],0),o=this._px(t[1],1);return[r,i]=a.a2p(...this._cs([r,i])),[l,o,r-s*l,i-n*o]}rect(t,e,r){let i=r?$($(r)[0]):this.create_child("rect"),s=t=>t.toFixed(this.svg.decimals),[n,a,l,o]=this.rect_xy(t,e);return i.attr({width:s(n),height:s(a),x:s(l),y:s(o)})}async image_promise(t,e){t=new URL(t,location.href).href;let r=e?$($(e)[0]):this.create_child("image");return load_img(t).then((e=>{let i=$(e).appendTo("body"),s={width:i.width(),height:i.height()};return i.remove(),[r.attr({href:t,x:0,y:0}),s]}))}_img_size(t,e){t||(t={scale:1});let r=t.scale;if(r){let[i,s]=[e.width,e.height];i&&s||console.warn("Sizing image with a dimension of 0"),t=[(r*i).toFixed(2),(r*s).toFixed(2)]}else t instanceof Array||(t=[t,t]);return t}async image(t,e,r,i){return this.image_promise(t,i).then((t=>{let i=t[1];t=t[0],e=this._img_size(e,i);let[s,n,a,l]=this.rect_xy(e,r),o=t=>t.toFixed(this.svg.decimals);return t.attr({width:o(s),height:o(n),x:o(a),y:o(l)})}))}async mjax(t,e,r,i){let s=this.group(),n=s.create_child("image");return null==e&&(e={scale:1}),e.scale&&(e={scale:e.scale/32}),i&&(t=`\\color{${i}}{${t}}`),mjax_svg(t).then((t=>{t.appendTo("body");let i=t[0].getBBox();t.remove(),e=this._img_size(e,i);let[a,l,o,h]=this.rect_xy(e,r),c=t=>t.toFixed(this.svg.decimals),u="data:image/svg+xml;base64,"+unicode_to_base64(t[0].outerHTML);return n.attr({href:u,width:c(a),height:c(l),x:c(o),y:c(h)}),s}))}plot(t,e,r,i){let s=this.group(".Plot","black@1","#0065fe"),n=this.svg,a=t=>t.toFixed(n.decimals);i&&(i*=n.angleDir),t instanceof Array||(t=zip(t.x,t.y));for(let l of t){let t;if(r?(t=s.group().config({pivot:l}),t.image(r,e,l),t=t.$):t=e instanceof Array?s.rect(e,l):s.circle(e,l),i){let[e,r]=n.a2p(...l);t.attr({transform:`rotate(${a(i)} ${a(e)},${a(r)})`})}}return s}label(t,e,r){let i,s,n=this.group(),a=e instanceof Array,l=r instanceof Array;if(t instanceof Array)[i,s]=t,[i,s]=a?[this._cs([0,i])[1],this._cs([0,s])[1]]:[this._cs([i,0])[0],this._cs([s,0])[0]];else if("number"==typeof t){let e=t;t=a?t=>t.toFixed(e):(t,r)=>r.toFixed(e)}let o=i||s,h=a?e.length:r.length;for(let c=0;c<h;c++){let h=a?e[c]:e,u=l?r[c]:r,[d,f]=this._cs([h,u]);if(o)l?a||n.line([d+i,f],[d+s,f]):n.line([d,f+i],[d,f+s]);else{let e=n.text(t(h,u,c),[d,f]);0==parseFloat(e.html())&&e.addClass("Zero")}}return o?n.css("black@1").$.addClass("Ticks Tick"+(l?"Y":"X")):(n.css("text",15).$.addClass("Labels Label"+(l?"Y":"X")),l&&n.css({"text-anchor":"end"})),n}tick_label(t,e,r,i,s){let n=["number","string"].indexOf(typeof i)>=0,a=e instanceof Array;return i&&this.label(n?[0,i]:i,e,r),null==s&&(s=0),a?this.label(t,e,s):this.label(t,s,r),this}poly(t,e){let r={points:this.svg.pts_str(t)};return $(e)[0]instanceof SVGElement?$(e).attr(r):this.create_child(e?"polygon":"polyline",r)}_cs_size(t){return"string"==typeof t?parseFloat(t)/this.svg.unit:t}_px_size(t){return"string"==typeof t?parseFloat(t):t*this.svg.unit}star(t,e,r){let i=star_points(t,this._cs_size(e),null==r?null:this._cs_size(r));return this.poly(i,1)}arrow(t,e,r){return new SVG2arrow(this,t,e,r)}locus(t,e,r){return new SVG2locus(this,t,e,r)}path(t){return new SVG2path(this,t)}line(t,e,r){let i=r?$($(r)[0]):this.create_child("line"),s=this.svg,n=t=>t.toFixed(s.decimals),[a,l]=s.a2p(...this._cs(t)),[o,h]=s.a2p(...this._cs(e));return i.attr({x1:n(a),y1:n(l),x2:n(o),y2:n(h)})}chevron(t,e,r){null==r&&(r="7");let i=r.ratio;i?r=r.size:i=1;let s=this.svg.scale,n=-(r=this._px_size(r))/s[0],a=i*r/s[1],l=this.group();return l.poly([[n,a],[0,0],[n,-a]]),l.config({shift:t,theta:e||0})}ray(t,e,r,...i){let s=this.group();s.$.addClass("Ray"),s.line(t,e);let n=s.seg=new Segment(...t,...e),a=this.svg,l=n.length;0==i.length&&(i=[.5]);for(let t of i)s.chevron(n.point(t*l),a.adjust_angle(n.deg),r);return s}grid(t,e,r){let i=this.group("grid");this._grid(i,t,e),this._grid(i,e,t,1);let s=i.$.addClass("Grid");return(null==r||r)&&s.find(".Axis").appendTo(s),i}_grid(t,e,r,i){if(3==e.length){let[s,n,a]=e,[l,o]=r;[s,n]=[Math.min(s,n),Math.max(s,n)],[l,o]=[Math.min(l,o),Math.max(l,o)],a<0&&(a=-a);let h=a/1e3;for(n+=h;s<=n;){let e=i?[[l,s],[o,s]]:[[s,l],[s,o]],r=t.line(...e);Math.abs(s)<h&&r.addClass("Axis").css({stroke:"black","stroke-width":"1px"}),s+=a}}}text(t,e,r){let i=this.svg,s=r?$($(r)[0]):this.create_child("text"),n=t=>t.toFixed(i.decimals),[a,l]=i.a2p(...this._cs(e));return s.attr({x:n(a),y:n(l)}).html(t)}gtext(t,e,r){e instanceof Array||(e=[e]);let i=this.group(...e);return i.text(t),i.ralign(r)}symb(...t){let e=this.group(".Symbol"),r=t=>"number"==typeof t?`${size}px`:t;for(let[i,s,n]of t){let t=0;"number"==typeof s&&([t,s]=[s,null]);let a=e.text(i,n);4&t&&a.css({"font-size":"60%"}),1&t&&a.css(SVG2._style.bold),2&t&&a.css(SVG2._style.ital),s&&(s.size&&a.css({"font-size":r(s.size)}),s.css&&a.css(s.css))}return e}ctext(...t){let e=[];for(let[r,i,s]of t){null==s&&(s={}),"string"==typeof s&&(s={css:s});let t=this.gtext(r,s.css?s.css:[],i);s.config&&t.config(s.config),e.push(t)}return e}ruler(t,e,r){"string"==typeof e&&(e=parseFloat(e)/Math.abs(this.svg.scale[1])),r=Object.assign({big:10,offset:0,tickSmall:.25,tickBig:.5},r);let i=this.group(".Ruler"),s=i.rulerLength=e*(t+2*r.offset),n=r.width?r.width:i.rulerLength/25;i.rect([s,n]);let a=e*r.offset-s/2;n/=2;for(let s=0;s<=t;s++)i.line([a,-n],[a,n*(2*(s%r.big?r.tickSmall:r.tickBig)-1)]),a+=e;return i}cylinder(t,e){let r=this.group(".Cylinder"),i=new RArray(t[0],0),s=i.neg().minus([0,e]),n=-1==r.svg.angleDir?2:0;return r.path(i).ver(-e).arc_to(s,t,n).ver(0).arc_to(i,t).close().update(),r.ellipse(t),r}pm(t,e,r){let i=this.group();return e&&i.rect([t/6,t],r),i.rect([t,t/6],r),i}stickman(t){let e=this.group(".Stickman","none","black@3"),r=t/8;e.circle(r,[0,7*r]),e.line([0,6*r],[0,3*r]);let i=1.2*r;e.poly([[-i,0],[0,3*r],[i,0]]);let s=new RArray(0,5*r);return r*=1.5,e.poly([s.plus(vec2d(r,uniform(150,210))),s,s.plus(vec2d(r,uniform(-30,30)))]),e}edot(t,e){e||(e=1);let r=.25*e,i=[[-e,r],[-e,-r]];if(-1==t)t=2;else if(i=[[-e,0],[0,e],[e,0],[0,-e],[-e,0],[0,e],[e,0],[0,-e]],t>4)for(let e=0;e<t-4;e++)i[e][1-e%2]=r,i[e+4][1-e%2]=-r;let s=this.group({stroke:"none"});for(let r=0;r<t;r++)s.circle(.125*e,i[r]);return s}graph(t){let e=this.svg,r=t.x,i=t.y;if(t.grid){let[r,i]=t.grid,[s,n,a,l]=e.lrbt;s=r*Math.round(s/r),n=r*Math.round(n/r),a=i*Math.round(a/i),l=i*Math.round(l/i),this.grid([s,n,r],[a,l,i],t.appendAxes)}if(r||i){let t=this.group(".AxisTitle","text"),s=t=>{let s=(t?i:r).title[1];return s instanceof Array||(s=t?[s,e.center[1]]:[e.center[0],s]),s};if(r){let e=[0,r.y?r.y:0];r.tick&&(this.tick_label(r.dec?r.dec:0,[...range(...r.tick)],0,r.tickSize?r.tickSize:"-6"),this.find("g.LabelX").config({shift:r.shift}).shift_by(e),this.find("g.TickX").shift_by(e)),r.title&&t.group().shift_by(e).text(r.title[0],s(0))}if(i){let e=[i.x?i.x:0,0];i.tick&&(this.tick_label(i.dec?i.dec:0,0,[...range(...i.tick)],i.tickSize?i.tickSize:"-6"),this.find("g.LabelY").config({shift:i.shift}).shift_by(e),this.find("g.TickY").shift_by(e)),i.title&&t.group().config({theta:90,shift:s(1)}).shift_by(e).text(i.title[0])}}let s=t.data;if(s){let t=this.group(".Series"),e=[];for(let r of s)if(r.plot)e.push(t.plot(...r.plot));else{let i=t.group(".Locus","#0065fe@2","none");if(e.push(i),r.connect){let t=r.connect;t instanceof Array||(t=zip(t.x,t.y)),i.poly(t)}else r.locus&&i.locus(...r.locus)}this.series=e}return this}error_bar_y(t,e,r,i,s){i=this._cs_size(i);let n=this.group().addClass("ErrorBar");return s?(n.line([e,t],[r,t]),t-=i/2,n.line([e,t],[e,t+i]),n.line([r,t],[r,t+i])):(n.line([t,e],[t,r]),t-=i/2,n.line([t,e],[t+i,e]),n.line([t,r],[t+i,r])),n}error_bar_x(t,e,r,i){return this.error_bar_y(r,t,e,i,1)}tip_to_tail(t,e){null==e&&(e={});let r=this.group(".TipToTail2D"),i=new RArray(0,0),s=Object.assign({tail:"7"},e);for(let e of t){let t=i,n=t.plus([e[0],0]);i=i.plus(e),(e[0]||e[1])&&(e[0]&&r.arrow({tail:t,tip:n},s).css(".Component"),e[1]&&r.arrow({tail:n,tip:i},s).css(".Component"),r.arrow({tail:t,tip:i},s))}if(t.length>1){if(i[0]&&i[1]){let t=[i[0],0];r.arrow({tail:[0,0],tip:t},s).$.addClass("Component Resultant"),r.arrow({tail:t,tip:i},s).$.addClass("Component Resultant")}r.arrow({tail:[0,0],tip:i},s).$.addClass("Resultant")}return r}energy_flow(t){SVG2.style(this.circle(t.radius),"none","#0065fe@3");let e=this.group("text",24);for(let i of t.labels){let[t,s,n,a]=i,l="$"==(r=t).charAt(0)?r.substring(1):SVG2.eq[r]?SVG2.eq[r]:null;l&&"$"!=t.charAt(0)&&console.log(t,l),n||(n="#0065fe"),l?this.mjax(l,{scale:1},s,n):e.gtext(t,n,s)}var r;e=this.group("arrow");for(let e of t.arrows){let[t,r,i,s,n]=e;n||(n="#0065fe");let a=this.arrow(t,{tail:"6"}).css(n).config({theta:i,shift:r});s&&(s instanceof Array||(s=[s,[t>0?"-6":"6","12"]]),a.label(...s).css({stroke:"none"}))}return this}coil(t,e,r,i,s){let n=this.group();n.$.addClass("Coil");let a=r?n.scaled([-1,1]):n,[l,o]=t;e||(e=15),i||(i=o/e/4),a.rect(t);for(let r=0;r<e+.5;r++){let s=(o-6*i)*(r-e/2)/e;a._turn(t[0],i,r==e?2:3).config({shift:[0,s]}).$.addClass("Wire"),0!=r&&r!=e||(s+=i*(r?2:-2),a.line([l/2,s],[l/2+2*i,s]).addClass("Wire"))}return null==s&&(s=.7*i),s&&a.circle(s),n}_turn(t,e,r){let i=this.group();null==r&&(r=0),t/=2;let s=i.path([t,1&r?4*e:2*e]);return 1&r&&s.arc([t,3*e],-90),s.line_to([-t,-2*e]),2&r&&s.arc([-t,-e],90,2),s.update(),i}}class SVG2scaled extends SVG2g{constructor(t,e,r){super(t,e);let i=this.svg,s=t=>t.toFixed(i.decimals),[n,a]=i.a2p(0,0);n=s(n),a=s(a);let l=s(-n),o=s(-a),[h,c]=this.scale="number"==typeof r?[r,r]:r;this.$.attr({transform:`translate(${n} ${a}) scale(${h} ${c}) translate(${l} ${o}) `})}get pivot(){return new RArray(0,0)}get shift(){return new RArray(0,0)}get theta(){return 0}update_transform(){return this}coord_to_parent(t){let[e,r]=this.scale;return new RArray(t[0]*e,t[1]*r)}coord_from_parent(t){let[e,r]=this.scale;return new RArray(t[0]/e,t[1]/r)}}class SVG2arrow extends SVG2g{constructor(t,e,r,i){super(t),this.$.addClass("Arrow"),this._poly=this.poly([],1),this.reshape(e,r,i)}reshape(t,e,r){let i=this.svg,[s,n]=(t=>{if("number"==typeof t)return[[-t/2,0],[t/2,0]];{let e=t.tail,r=t.tip;if(null==e&&(e=[0,0]),null==r){let i=t.angle;r=vec2d(t.length,i||0).plus(e)}return[e,r]}})(t);s=i._cs(s),n=i._cs(n);let a=this.seg=new Segment(...s,...n);r?"string"==typeof r&&(r=["tail","center","tip"].indexOf(r)-1):r=0,this.pivot=a[-1==r?"point1":1==r?"point2":"midpoint"];let l=t=>Math.abs("string"==typeof t?parseFloat(t):t*i.scale[1]),o={};e&&(o=Object.assign(o,e),o.tail&&(o.tail=l(o.tail)),o.head&&(o.head=l(o.head))),a=new Segment(...i.a2p(...s),...i.a2p(...n));let h=arrow_points(a.length,o);h=transform({angle:a.deg,deg:!0,shift:a.midpoint},...h);for(let t=0;t<h.length;t++)h[t]=i.p2a(...h[t]);return this.poly(h,this._poly),this}label(t,e){return this.gtext(t,["text","none@"],this.seg.midpoint.plus(this._cs(e)))}}class SVG2locus{constructor(t,e,r,i){let s=this.svg=t.svg;this.eq=e,r||(r=[s.lrbt[0],s.lrbt[1]]),this.param=r.length>2?r:r.concat([s.$.width()/3]),this.args=i,this.$=t.create_child("polyline",{}).addClass("Locus"),this.css("none"),this.element=this.$[0],this.element.graphic=this,this.update()}css=SVG2g.prototype.css;config(t){for(let e in t)this[e]=t[e];return this}update(){let t=this.svg,e=t.time,[r,i]=[this.eq,this.args],[s,n,a]=this.param;a=(n-s)/Math.round(a),n+=a/2;let l=[];for(;s<=n;){let t=r(s,e,i);if(!1===t)return;l.push("number"==typeof t?[s,t]:t),s+=a}return this.$.attr({points:t.pts_str(l)}),this}get animated(){return this.svg.items.indexOf(this)>-1}set animated(t){SVG2.set_animated(this,t)}}class SVG2path{constructor(t,e){this.g=t,this.svg=t.svg,this.$=t.create_child("path",{}),this.d="",this.move_to(null==e?[0,0]:e)}move_to(t,e){let r=this.svg,i=t=>t.toFixed(r.decimals),[s,n]=t;return this.x=s,this.y=n,[s,n]=r.a2p(...t),this.d+=`${e||"M"} ${i(s)} ${i(n)} `,this}line_to(t){return this.move_to(t,"L")}lines_to(...t){for(let e of t)this.line_to(e);return this}hor(t){let e=this.svg;return this.x=t,t=e.a2p(t,0)[0],this.d+=`H ${(t=>t.toFixed(e.decimals))(t)} `,this}ver(t){let e=this.svg;var r;return this.y=t,t=e.a2p(0,t)[1],this.d+=`V ${r=t,r.toFixed(e.decimals)} `,this}arc_to(t,e,r,i){let s,n,a=this.svg,l=t=>t.toFixed(a.decimals);e instanceof Array?[s,n]=e:s=n=e,s=a._px(s,0),n=a._px(n,1),i=i?l(i*a.angleDir):"0";let[o,h]=t;this.x=o,this.y=h,[o,h]=a.a2p(o,h);let c=0,u=0;return r&&(c=1&r,u=2&r?1:0),this.d+=`A ${l(s)} ${l(n)} ${i} ${c} ${u} ${l(o)} ${l(h)} `,this}arc(t,e,r){let i=(t=new RArray(...t)).minus([this.x,this.y]).neg(),s=i.mag(),n=i.dir();null==r&&(r=Math.max(e,n)-Math.min(e,n)>=180?1:0,e<n&&(r+=2));let a=t.plus([s*cos(e),s*sin(e)]);return this.arc_to(a,s,r)}curve_to(t,e,r){let i=this.svg,s=t=>t.toFixed(i.decimals),[n,a]=t;this.x=n,this.y=a,[n,a]=i.a2p(n,a);let[l,o]=i.a2p(...e),[h,c]=i.a2p(...r);return this.d+=`C ${s(l)} ${s(o)}, ${s(h)} ${s(c)}, ${s(n)} ${s(a)} `,this}quad_to(t,e){let r=this.svg,i=t=>t.toFixed(r.decimals),[s,n]=t;this.x=s,this.y=n,[s,n]=r.a2p(s,n);let[a,l]=r.a2p(...e);return this.d+=`Q ${i(a)} ${i(l)}, ${i(s)} ${i(n)} `,this}close(){return this.d+="Z ",delete this.x,delete this.y,this}update(){return this.$.attr({d:this.d.trim()})}}class SVG2 extends SVG2g{constructor(t,e){super(),this.svg=this,this.element=$(t).filter("svg")[0],t=this.$=$(this.element).attr("xmlns",SVG2.nsURI),this.element.graphic=this,this.items=[],this.decimals=2;let r=e.margin?e.margin:0;"number"==typeof r&&(r=[r,r,r,r]);let i=e.lrbt,s=e.scale;!s||s instanceof Array||(s=[s,s]);let[n,a]=e.size?e.size:s&&i.length>3?[s[0]*(i[1]-i[0])+r[0]+r[1]+1,s[1]*(i[3]-i[2])+r[2]+r[3]+1]:[t.width(),t.height()];if(n=Math.abs(Math.round(n)),a=Math.abs(Math.round(a)),t.attr({width:n,height:a,"data-aspect":n/a,viewBox:`0 0 ${n} ${a}`}),i){let[t,e,s,l]=r;i.length<4&&(i=SVG2.auto_lrbt(n-r[0]-r[1],a-r[2]-r[3],...i)),this.coords_by_map([t,a-1-s],[i[0],i[2]],[n-1-e,l],[i[1],i[3]])}else i=[0,n-1,0,a-1],this.coords_by_map([0,0],[0,0],[1,1],[1,1]),this.p2a=this.a2p=(t,e)=>new RArray(t,e);this.lrbt=i;let l=e.grid;if(l){let[t,r]="number"==typeof l?[l,l]:l,s=t*Math.round(i[0]/t),n=r*Math.round(i[2]/r),a=this.grid([s,i[1],t],[n,i[3],r],e.appendAxes);e.noAxes&&a.$.find(".Axis").removeClass("Axis").css(SVG2._style.grid)}this.playing=!1,this.frameRate=60,this.frameCount=0,this.timeFactor=1,this.time=0}static arr(t){return["→",5,[0,null==t?"20":t]]}get size(){let t=this.$;return[parseFloat(t.attr("width")),parseFloat(t.attr("height"))]}get url(){return"data:image/svg+xml;base64,"+unicode_to_base64(this.element.outerHTML)}static async cleanup_svg(t,e){let r=(t=$(t).removeAttr("class style"))[0].attributes,i=[];for(let t=0;t<r.length;t++){let e=r.item(t);"data"==e.name.split("-")[0]&&i.push(e.name)}for(let e of i)t.removeAttr(e);if(e){t.appendTo("body"),$(document.createElementNS(SVG2.nsURI,"rect")).prependTo(t).attr({x:0,y:0,width:t.width(),height:t.height(),style:`fill: ${e}`}),t.remove()}let s=[],n=[];for(let e of t.find("image")){let t=$(e).attr("href");"data:"!=t.substring(0,5)&&(n.push(e),s.push(t))}return load_dataURLs(...s).then((e=>{for(let t=0;t<s.length;t++){let r=e[s[t]];$(n[t]).attr({href:r})}return t[0]}))}static async svg_to_cv(t,e){return load_img("data:image/svg+xml;base64,"+unicode_to_base64(t.outerHTML)).then((t=>{let r=$(t).appendTo("body"),i=img2canvas(t,e);return r.remove(),i}))}async image_cv(t,e){return SVG2.cleanup_svg(this.element.outerHTML,e).then((e=>SVG2.svg_to_cv(e,t)))}async save(t){return SVG2.cleanup_svg(this.element.outerHTML).then((t=>blobify(t.outerHTML,"image/svg+xml"))).then((e=>e.save(t)))}async save_image(t,e,r){1==t&&(t=`${random_string(12,1)}.png`);let i=t?t.split(".").item(-1).toLowerCase():"png";return"jpg"==i&&(i="jpeg"),this.image_cv(e,r).then((t=>blobify(t,"image/"+i))).then((e=>e.save(t)))}get defs(){let t=this.$.find("defs");return 0==t.length&&(t=this.create_child("defs").prependTo(this.$)),t}get center(){let[t,e,r,i]=this.lrbt;return new RArray((t+e)/2,(r+i)/2)}clip_rect(t,e){null==t&&(t=0),t=this._cs(t instanceof Array?t:[t,t]).times(2);let r=this.group(),[i,s,n,a]=this.lrbt;return r.rect([Math.abs(s-i)+t[0],Math.abs(a-n)+t[1]],this.center),r.clip_path(e||"lrbt"),this}gradient(t,e,r,i,s,n,a){let l=(t,e)=>{let r=document.createElementNS(SVG2.nsURI,t);return null!=e&&$(r).attr(e),r},o=$(l("linearGradient",{id:t,x1:`${null==i?0:i}%`,x2:`${null==s?100:s}%`,y1:`${null==n?0:n}%`,y2:`${null==a?0:a}%`})).appendTo(this.defs[0]);return o.append(l("stop",{offset:"0%","stop-color":e})),o.append(l("stop",{offset:"100%","stop-color":r})),this}static create(t){return new SVG2(document.createElementNS(SVG2.nsURI,"svg"),t)}static auto_lrbt(t,e,r,i,s,n){if(null==n){let a=(e-1)*(i-r)/(t-1);null==s?s=-(n=a/2):n=s+a}return[r,i,s,n]}update_transform(){return this}coords_by_map(t,e,r,i){let[s,n]=new RArray(...i).minus(e),[a,l]=new RArray(...r).minus(t),o=a/s,h=l/n,c=this.scale=new RArray(o,h);this.unit=Math.sqrt((o*o+h*h)/2),this.angleDir=o*h<0?-1:1;let u=new RArray(-1/o,-1/h);t=new RArray(...t).minus(c.times(e)),this.a2p=(e,r)=>t.plus(c.times([e,r])),this.p2a=(e,r)=>t.minus([e,r]).times(u)}event_coords(t){let e=this.$,r=parseFloat(e.css("padding-left"))+parseFloat(e.css("border-left-width")),i=parseFloat(e.css("padding-top"))+parseFloat(e.css("border-top-width")),s=this.element.getBoundingClientRect(),n=new RArray(t.clientX-(s.x+r),t.clientY-(s.y+i));return n[0]*=parseFloat(e.attr("width"))/e.width(),n[1]*=parseFloat(e.attr("height"))/e.height(),{pixels:n,coords:this.p2a(...n)}}adjust_angle(t,e){let[r,i]=this.scale;return e&&(r=1/r,i=1/i),atan2(i*this.angleDir*sin(t),r*cos(t))}group(...t){let e=new SVG2g(this);return t&&e.css(...t),e}pts_str(t){let e="",r=t=>t.toFixed(this.decimals);for(let i=0;i<t.length;i++){let[s,n]=this.a2p(...this._cs(t[i]));e+=(e.length?" ":"")+`${r(s)},${r(n)}`}return e}static set_animated(t,e){let r=t.svg,i=r.items,s=i.indexOf(t);e?-1==s&&r.animate(t):s>-1&&i.splice(s,1)}animate(...t){for(let e of t)e.update||(e=$(e)[0].graphic),-1==this.items.indexOf(e)&&this.items.push(e);return this}unanimate(...t){let e=this.items;for(let r=e.length-1;r>=0;r--)t.indexOf(e[r])>-1&&e.splice(r,1);return this}update(t){clearTimeout(this._animate);let e=null==t;e&&(t=this.timeFactor/this.frameRate),this.beforeupdate&&this.beforeupdate.call(this);for(let e of this.items)try{e.beforeupdate&&e.beforeupdate(e),e.update(t),e.afterupdate&&e.afterupdate(e)}catch(t){console.warn(t)}this.time+=t,t=1e3/this.frameRate;let r=this._nextFrame-Date.now();return r<=0?(r=1,this._nextFrame=Date.now()+t-1):this._nextFrame+=t,e&&this.frameCount++,this.afterupdate&&this.afterupdate.call(this),this.playing&&(this._animate=setTimeout((()=>{this.update()}),r)),this}play(){return this.playing=!0,this._nextFrame=Date.now()+1e3/this.frameRate,this._fpsDebug&&(this._fpsDebug=[this.frameCount,Date.now()]),this.update()}pause(){if(clearTimeout(this._animate),this.playing=!1,this._fpsDebug){let[t,e]=this._fpsDebug;t=this.frameCount-t,e=(Date.now()-e)/1e3,console.log(`${t} frames / ${e} sec = ${t/e} fps`)}return this}toggle(){return this.playing?this.pause():this.play()}click_toggle(t,e,r){let i=[()=>click_cycle.toggle(this,!1,...range(t))];for(let e=0;e<t;e++)i.push((()=>click_cycle.toggle(this,!0,e)));if(click_cycle(this.element,null==r?-1:r,...i),e)for(let t=0;t<e;t++)this.$.trigger("click");return this}static async load(cb){let svgs=$("svg[data-svg2]"),pending={},ts=Date.now();for(let svg of svgs){let[url,id,args]=$(svg).attr("data-svg2").split("#");url=new URL(url,SVG2.url).href,svg.info=[url,id,args],null==pending[url]&&null==SVG2._cache[url]&&(pending[url]=fetch(`${url}?_=${ts}`).then((t=>t.text())).then(eval))}for(let t in pending)await pending[t];for(let t of svgs){let[e,r,i]=t.info;delete t.info;let s=`${e}#${r}`;if(i&&(s+=`#${i}`),$(t).removeAttr("data-svg2").attr("data-svg2x",s),i){try{i=jeval(i)}catch(t){console.warn(t)}i instanceof Array||(i=[i])}else i=[];try{SVG2._cache[e][r](t,...i)}catch(t){console.warn(t)}}return cb?cb():null}static cache_run(t,e,...r){return SVG2._cache[new URL(t,SVG2.url).href][e](...r)}static cache(t,e){SVG2._cache[new URL(t,SVG2.url).href]=e}static make_URL(t){return new URL(t,SVG2.url).href}static cached(t){return SVG2._cache[new URL(t,SVG2.url).href]}static vec_diag(t,e,r){let i=new SVG2(t,r);r||(r={});let s=i.tip_to_tail(e);if(r.shift&&s.config({shift:r.shift}),r.label){let[t,e,s,n]=r.label,[a,l,o,h]=i.lrbt;a=t*Math.ceil(a/t),o=t*Math.ceil(o/t);let c=r.tick;c?(i.tick_label(e,0,[...range(o,h+t/10,t)],c,s),i.tick_label(e,[...range(a,l+t/10,t)],0,c,n)):(i.label(e,s,[...range(o,h+t/10,t)]),i.label(e,[...range(a,l+t/10,t)],n))}s.$.appendTo(i.$);for(let t of"XY"){let e=i.find(`g.Label${t}`);e&&e.shift_by([0,"-5"])}return i.$.find(".Zero").hide(),-1==r.cycle?s.$.find(".Component").hide():r.cycle&&i.vec_cycle(s.$,e.length>1),s.$.find(".Arrow").css(SVG2._style.arrow),s.$.find(".Resultant").css({fill:"#0065fe"}),s.$.find(".Component").css({fill:"yellow"}),i}vec_cycle(t,e){return t.find(".Component").hide(),e?click_cycle(this.element,0,(()=>{t.find(".Component").fadeOut()}),(()=>{t.find(".Resultant").fadeOut(),t.find(".Component:not(.Resultant)").fadeIn()}),(()=>{t.find(".Component:not(.Resultant)").fadeOut(),t.find(".Component.Resultant").fadeIn()}),(()=>{t.find(".Resultant").fadeIn()})):this.$.on("click",(()=>t.find(".Component").fadeToggle())),this}static vec_diag_table(t,e,r,i){let s=$("<table>").addClass("VectorTable"),n=$("<thead>").appendTo(s),a=$("<tr>").appendTo(n),l="Δ"==t.charAt(0)?`\\Delta\\vec{\\bf ${t.substring(1)}}`:`\\vec{\\bf ${t}}`;for(let t of[`|${l}|`,"\\theta",`${l}_x`,`${l}_y`])a.append($("<th>").addClass("TeX").html(t));a=$("<tr>").appendTo(n);for(let t of[`\\sqrt{(${l}_x)^2 + (${l}_y)^2}`,`\\tan^{-1}\\frac{${l}_y}{${l}_x}`,`|${l}| \\cos\\theta`,`|${l}| \\sin\\theta`])a.append($("<th>").html($("<p>").html(t).addClass("TeX")));let o=$("<tbody>").appendTo(s),h=new RArray(0,0);for(let t of e)i&&(t=new RArray(...t).times(i)),h=h.plus(t),o.append(new RArray(...t).tr(r||4));return o.append(new RArray(...h).tr(r||4).addClass("Resultant")),renderTeX(n.find(".TeX")),s}static ebg(t,e,r,i,s){s=Object.assign({size:[512,384],width:.5,duration:0,unit:"J",margin:[32,4,44,16]},s);let n=i.length,a=new SVG2(t,{size:s.size,lrbt:[0,n,0,e],margin:s.margin});a.grid([0,n],[0,e,r]).grid([0,1,2],[0,e]);let l=[],o=a.group(".MJax");for(let t=0;t<n;t++){let e=i[t],r=e[2]?e[2]:"#0065fe";l.push(a.rect([s.width,1],[t+.5,1]).css({fill:r}));let n=e[0];SVG2.eq[n]&&(n=SVG2.eq[n]),o.mjax(n,{scale:1},[[t+.5,"-8"],[.5,0]],r)}if(a.config({data:i,options:s}),a.$.find("g.Grid line.Axis").appendTo(a.$),s.E&&a.line([0,s.E],[n,s.E]).addClass("TotalEnergy").css({stroke:"black","stroke-width":"2px"}),s.label){let[t,i,n]=s.label,l=a.label(t,i,[...range(0,e+r,n?n*r:r)]),o=s.yShift;l.shift_by([0,null!=o?o:"-6"]),s.unit&&l.text(s.unit,["6",e]).css({"text-anchor":"start"}),l.$.find(".Zero").removeClass("Zero"),l.$.find("text").css({"font-size":"16px"})}return a.beforeupdate=function(){let t=this.time,e=this.options;if(e.duration&&t>e.duration)this.pause(),this.time=e.duration;else{let r=0,i=0,s=e.width,n=l.length;e.duration&&(t/=e.duration);for(let e=0;e<n;e++){let n=this.data[e][1];if(!0===n)i+=1;else{let i="number"==typeof n?n:n(t);r+=i,a.rect([s,i],[e+.5,i/2],l[e])}}let o=(e.E-r)/i;for(let t=0;t<n;t++){!0===this.data[t][1]&&a.rect([s,o],[t+.5,o/2],l[t])}}},a.$.on("click",(()=>{a.time>=a.options.duration&&!a.playing?(a.time=0,a.update(0)):a.toggle()})),a.update(0)}static*spring_points(t,e,r,i,s){let n=new Segment(...t,...e),a=n.length;i||(i=a/10),s||(s=a/10);let l=(a-2*i)/(2*r),o=n.normal.times(s);yield n.point(0);let h=i;for(let t=0;t<=r;t++)yield n.point(h).plus(o.times(t?t%2?1:-1:0)),h+=(t?2:1)*l;yield n.point(a-i),yield n.point(a)}static style(t,...e){let r=t=>isNaN(t)?t:`${t}px`;for(let i of e){let e=["string","number"].indexOf(typeof i);-1==e?t.css(i):0==e?"."==i.charAt(0)?t.addClass(i.substring(1)):SVG2._style[i]?t.css(SVG2._style[i]):(i=i.split("@"),1==i.length?t.css({fill:i[0]}):(i[0]&&t.css({stroke:i[0]}),i[1]&&t.css({"stroke-width":r(i[1])}))):1==e&&t.css({"font-size":r(i)})}return t}}SVG2.nsURI="http://www.w3.org/2000/svg",SVG2._cache={},SVG2.load.pending=[],SVG2.url=location.origin,"http://localhost"!=SVG2.url.substring(0,16)&&(SVG2.url+="/sci/"),SVG2.sans="'Noto Sans', 'Open Sans', 'Droid Sans', Oxygen, sans-serif",SVG2.mono="Inconsolata, 'Droid Sans Mono', monospace",SVG2.symbol=SVG2.serif="'Noto Serif', 'Open Serif', 'Droid Serif', serif",SVG2._style={grid:{stroke:"lightgrey","stroke-width":"0.5px"},text:{"font-family":SVG2.sans,"font-size":"18px","text-anchor":"middle"},start:{"text-anchor":"start"},middle:{"text-anchor":"middle"},end:{"text-anchor":"end"},symbol:{"font-family":SVG2.symbol,"font-size":"18px","text-anchor":"middle"},arrow:{fill:"red",stroke:"black","stroke-width":"0.5px","fill-opacity":.8},ital:{"font-style":"italic"},bold:{"font-weight":"bold"},nostroke:{stroke:"none"},nofill:{fill:"none"},sans:{"font-family":SVG2.sans},serif:{"font-family":SVG2.serif},mono:{"font-family":SVG2.mono}},SVG2.eq={Ek:"E_k",Eg:"E_g"};